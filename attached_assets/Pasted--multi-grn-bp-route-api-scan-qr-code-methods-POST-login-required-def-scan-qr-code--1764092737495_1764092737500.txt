@multi_grn_bp.route('/api/scan-qr-code', methods=['POST'])
@login_required
def scan_qr_code():
    """API endpoint to scan QR code and mark line item as verified - with quantity validation"""
    try:
        data = request.get_json()
        qr_data = data.get('qr_data', '')

        if not qr_data:
            return jsonify({'success': False, 'error': 'QR code data is required'}), 400

        try:
            qr_json = json.loads(qr_data)
            grn_id = qr_json.get('id', '')  # Full GRN with pack number (e.g., MGN-13-22-1-1)
            qr_qty = qr_json.get('qty', 0)  # Quantity from QR code
        except:
            return jsonify({'success': False, 'error': 'Invalid QR code format'}), 400

        if not grn_id:
            return jsonify({'success': False, 'error': 'QR code ID is missing'}), 400

        logging.info(f"üîç QR scan received: GRN ID={grn_id}, Qty={qr_qty}")

        from modules.multi_grn_creation.models import MultiGRNBatchDetails, MultiGRNSerialDetails, \
            MultiGRNBatchDetailsLabel

        # Query database using FULL GRN number (including pack suffix)
        # This ensures each pack is matched individually: MGN-18-43-1-1, MGN-18-43-1-2, etc.
        logging.info(f"üîç Searching DB for: {grn_id}")
        parts = grn_id.split("-")
        main_grn = "-".join(parts[:5])  # Example: MGN-13-22-1
        main_grns = "-".join(parts[:4])

        header_grn = MultiGRNBatchDetails.query.filter_by(grn_number=main_grns).first()
        verifyCheck = MultiGRNBatchDetailsLabel.query.filter_by(grn_number=main_grns).first()
        # batch_detail = MultiGRNBatchDetailsLabel.query.filter_by(grn_number=main_grn).first()
        
        line_item = MultiGRNBatchDetailsLabel.query.filter_by(grn_number=main_grn).first()
        line_item.status = 'verified'
            # batch_details.status= 'verified'
            # db.session.commit()
            # 1. Mark this pack as verified
            # batch_detail.status = 'verified'
        db.session.commit()
        # batch_detail = MultiGRNBatchDetails.query.filter_by(grn_number=grn_id).first()
        # serial_detail = MultiGRNSerialDetails.query.filter_by(grn_number=grn_id).first()
        batch_detail = MultiGRNBatchDetailsLabel.query.filter(
            MultiGRNBatchDetailsLabel.status.like(f"{'pending'}%")
        ).all()
        print("ujukuj",line_item)
        if len(batch_detail) == 0:
            # Check if already verified
            if line_item.status == 'verified':
                logging.info(f"‚ÑπÔ∏è Pack already verified: GRN={grn_id}")
                return jsonify({
                    'success': True,
                    'message': 'This pack was already verified',
                    'already_verified': True,
                    'detail_type': 'batch',
                    'item_info': {
                        'batch_number': header_grn.batch_number,
                        'quantity': float(line_item.qty_in_pack),
                        'grn_number': line_item.grn_number
                    }
                })

            # Validate quantity matches (QR qty should match database quantity for this pack)
            db_pack_qty = int(float(line_item.qty_in_pack))
            qr_pack_qty = int(qr_qty)

            if qr_pack_qty != db_pack_qty:
                logging.error(f"‚ùå Quantity mismatch: GRN={grn_id}, QR Qty={qr_pack_qty}, DB Qty={db_pack_qty}")
                return jsonify({
                    'success': False,
                    'error': f'Quantity mismatch! QR label shows {qr_pack_qty} but database expects {db_pack_qty} for pack {grn_id}. Please verify the correct label.'
                }), 400

            # Mark as verified
            line_item.status = 'verified'
            # batch_details.status= 'verified'
            # db.session.commit()
            # 1. Mark this pack as verified
            # batch_detail.status = 'verified'
            db.session.commit()

            # 2. Check if all packs for this GRN are verified
            # pending = MultiGRNBatchDetailsLabel.query.filter(
            #     verifyCheck.id == batch_details.batch_detail_id,
            #     MultiGRNBatchDetailsLabel.status != 'verified'
            # ).count()
            batch_detail = MultiGRNBatchDetailsLabel.query.filter(
            MultiGRNBatchDetailsLabel.grn_number.like(f"{header_grn}-%"),
            MultiGRNBatchDetailsLabel.status != "verified"
        ).count()

            if batch_detail == 0:
                # 3. All packs verified ‚Üí Update summary table
                header_grn.status = 'verified'
                db.session.commit()
                final_status = "All packs verified ‚Äì header updated"
                print(final_status)
            else:
                final_status = f"{header_grn} packs still pending"
                print(final_status)
            logging.info(f"‚úÖ Pack verified: GRN={grn_id}, Batch={header_grn.batch_number}, Qty={qr_pack_qty}")

            # from modules.multi_grn_creation.models import MultiGRNBatchDetails, MultiGRNSerialDetails,MultiGRNBatchDetailsLabel
        #
        # # Query database using FULL GRN number (including pack suffix)
        # # This ensures each pack is matched individually: MGN-18-43-1-1, MGN-18-43-1-2, etc.
        # logging.info(f"üîç Searching DB for: {grn_id}")
        # parts = grn_id.split("-")
        # main_grn = "-".join(parts[:5])   # Example: MGN-13-22-1
        # main_grns = "-".join(parts[:4])
        # print("Searching DB for:", main_grn)
        # batch_details = MultiGRNBatchDetails.query.filter_by(grn_number=main_grns).first()
        # batch_detail = MultiGRNBatchDetailsLabel.query.filter_by(grn_number=main_grn).first()
        # print(batch_details)
        # serial_detail = MultiGRNBatchDetailsLabel.query.filter_by(grn_number=main_grn).first()
        # # batch_detail = MultiGRNBatchDetails.query.filter_by(grn_number=grn_id).first()
        # # serial_detail = MultiGRNSerialDetails.query.filter_by(grn_number=grn_id).first()
        #
        # if batch_detail:
        #     # Check if already verified
        #     if batch_detail.status == 'verified':
        #         logging.info(f"‚ÑπÔ∏è Pack already verified: GRN={grn_id}")
        #         return jsonify({
        #             'success': True,
        #             'message': 'This pack was already verified',
        #             'already_verified': True,
        #             'detail_type': 'batch',
        #             'item_info': {
        #                 'batch_number': batch_details.batch_number,
        #                 'quantity': float(batch_detail.qty_in_pack),
        #                 'grn_number': batch_detail.grn_number
        #             }
        #         })
        #
        #     # Validate quantity matches (QR qty should match database quantity for this pack)
        #     db_pack_qty = int(float(batch_detail.qty_in_pack))
        #     qr_pack_qty = int(qr_qty)
        #
        #     if qr_pack_qty != db_pack_qty:
        #         logging.error(f"‚ùå Quantity mismatch: GRN={grn_id}, QR Qty={qr_pack_qty}, DB Qty={db_pack_qty}")
        #         return jsonify({
        #             'success': False,
        #             'error': f'Quantity mismatch! QR label shows {qr_pack_qty} but database expects {db_pack_qty} for pack {grn_id}. Please verify the correct label.'
        #         }), 400
        #
        #     # Mark as verified
        #     batch_detail.status = 'verified'
        #     batch_details.status= 'verified'
        #     db.session.commit()
        #
        #     logging.info(f"‚úÖ Pack verified: GRN={grn_id}, Batch={batch_details.batch_number}, Qty={qr_pack_qty}")
        #
            return jsonify({
                'success': True,
                'message': f'Pack verified successfully! Batch: {header_grn.batch_number}, Qty: {qr_pack_qty} matched',
                'detail_type': 'batch',
                'item_info': {
                    'batch_number': header_grn.batch_number,
                    'quantity': float(batch_detail.qty_in_pack),
                    'grn_number': batch_detail.grn_number
                }
            })

        elif line_item:
            # Check if already verified
            if line_item.status == 'verified':
                logging.info(f"‚ÑπÔ∏è Serial already verified: GRN={grn_id}")
                return jsonify({
                    'success': True,
                    'message': 'This serial was already verified',
                    'already_verified': True,
                    'detail_type': 'serial',
                    'item_info': {
                        'serial_number': line_item.serial_number,
                        'grn_number': line_item.grn_number
                    }
                })

            # Validate quantity matches
            db_serial_qty = int(float(line_item.qty_per_pack)) if line_item.qty_per_pack else 1
            qr_serial_qty = int(qr_qty)

            if qr_serial_qty != db_serial_qty:
                logging.error(f"‚ùå Quantity mismatch: GRN={grn_id}, QR Qty={qr_serial_qty}, DB Qty={db_serial_qty}")
                return jsonify({
                    'success': False,
                    'error': f'Quantity mismatch! QR label shows {qr_serial_qty} but database expects {db_serial_qty} for pack {grn_id}. Please verify the correct label.'
                }), 400

            # Mark as verified
            line_item.status = 'verified'
            db.session.commit()

            logging.info(f"‚úÖ Serial verified: GRN={grn_id}, Serial={line_item.serial_number}, Qty={qr_serial_qty}")

            return jsonify({
                'success': True,
                'message': f'Serial verified successfully! Serial: {line_item.serial_number}, Qty: {qr_serial_qty} matched',
                'detail_type': 'serial',
                'item_info': {
                    'serial_number': line_item.serial_number,
                    'grn_number': line_item.grn_number
                }
            })

        else:
            logging.error(f"‚ùå Pack not found in database: GRN={grn_id}")
            return jsonify({
                'success': False,
                'error': f'Pack {grn_id} not found in this batch. Please ensure you are scanning the correct QR label for this batch.'
            }), 404

    except Exception as e:
        logging.error(f"Error scanning QR code: {str(e)}")
        db.session.rollback()
        return jsonify({'success': False, 'error': str(e)}), 500
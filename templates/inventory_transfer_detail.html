{% extends "base.html" %}

{% block title %}Inventory Transfer Detail - {{ transfer.transfer_request_number }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('inventory_transfer') }}">Inventory Transfer</a></li>
                    <li class="breadcrumb-item active">{{ transfer.transfer_request_number }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Transfer Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i data-feather="arrow-right"></i> 
                            Inventory Transfer - {{ transfer.transfer_request_number }}
                        </h5>
                        <div>
                            {% if transfer.status == 'draft' %}
                                <span class="badge bg-secondary">Draft</span>
                            {% elif transfer.status == 'submitted' %}
                                <span class="badge bg-warning text-dark">Submitted</span>
                            {% elif transfer.status == 'qc_approved' %}
                                <span class="badge bg-success">QC Approved</span>
                            {% elif transfer.status == 'posted' %}
                                <span class="badge bg-primary">Posted</span>
                            {% elif transfer.status == 'rejected' %}
                                <span class="badge bg-danger">Rejected</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Transfer Request:</strong> {{ transfer.transfer_request_number }}</p>
                            <p><strong>SAP Document:</strong> {{ transfer.sap_document_number or 'Not assigned' }}</p>
                            <p><strong>Status:</strong> {{ transfer.status.title() }}</p>
                            <p><strong>From Warehouse:</strong> 
                                {% set from_wh = transfer.from_warehouse or (sap_transfer_data.get('FromWarehouse') if sap_transfer_data else None) %}
                                {% if from_wh %}
                                    <span class="badge bg-info">{{ from_wh }}</span>
                                {% else %}
                                    <span class="text-warning">Not specified</span>
                                {% endif %}
                            </p>
                            <p><strong>To Warehouse:</strong> 
                                {% set to_wh = transfer.to_warehouse or (sap_transfer_data.get('ToWarehouse') if sap_transfer_data else None) %}
                                {% if to_wh %}
                                    <span class="badge bg-success">{{ to_wh }}</span>
                                {% else %}
                                    <span class="text-warning">Not specified</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Created By:</strong> {{ transfer.user.first_name }} {{ transfer.user.last_name }}</p>
                            <p><strong>Created At:</strong> {{ transfer.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                            <p><strong>Updated At:</strong> {{ transfer.updated_at.strftime('%Y-%m-%d %H:%M') }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transfer Items -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i data-feather="package"></i> 
                            Transfer Items
                        </h6>
                        {% if transfer.status == 'draft' %}
                        <div class="btn-group">
                            <button class="btn btn-sm btn-success" onclick="showAddItemModal()">
                                <i data-feather="plus"></i> Add Item
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="showQRScannerForTransfer()">
                                <i data-feather="maximize"></i> Scan QR Label
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    {% if transfer.items %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Item Code</th>
                                    <th>Description</th>
                                    <th>Quantity</th>
                                    <th>UoM</th>
                                    <th>From Warehouse/Bin</th>
                                    <th>To Warehouse/Bin</th>
                                    <th>Batch</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in transfer.items %}
                                <tr>
                                    <td><strong>{{ item.item_code }}</strong></td>
                                    <td>{{ item.item_name }}</td>
                                    <td>{{ item.quantity }}</td>
                                    <td><strong>{{ item.unit_of_measure or 'EA' }}</strong></td>
                                    <td>
                                        {% set from_warehouse = item.from_bin.split('-')[0] if item.from_bin and '-' in item.from_bin else item.from_bin[:4] if item.from_bin else 'N/A' %}
                                        <strong>{{ from_warehouse }}</strong> / {{ item.from_bin or 'N/A' }}
                                    </td>
                                    <td>
                                        {% set to_warehouse = item.to_bin.split('-')[0] if item.to_bin and '-' in item.to_bin else item.to_bin[:4] if item.to_bin else 'N/A' %}
                                        <strong>{{ to_warehouse }}</strong> / {{ item.to_bin or 'N/A' }}
                                    </td>
                                    <td>{{ item.batch_number or '-' }}</td>
                                    <td>
                                        {% if transfer.status == 'draft' %}
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-primary" onclick="editItem({{ item.id }}, '{{ item.item_code }}', '{{ item.item_name }}', {{ item.quantity }}, '{{ item.unit_of_measure }}', '{{ item.from_bin }}', '{{ item.to_bin }}', '{{ item.batch_number or '' }}')">
                                                <i data-feather="edit"></i>
                                            </button>
<!--                                            {% set from_wh = item.from_bin.split('-')[0] if item.from_bin and '-' in item.from_bin else (item.from_bin[:4] if item.from_bin else 'N/A') %}-->
<!--                                            {% set to_wh = item.to_bin.split('-')[0] if item.to_bin and '-' in item.to_bin else (item.to_bin[:4] if item.to_bin else 'N/A') %}-->
<!--                                            <button class="btn btn-sm btn-success" onclick="generateTransferQRLabel('{{ item.item_code }}', '{{ item.item_name }}', '{{ item.batch_number or '' }}', {{ transfer.id }}, '{{ transfer.transfer_request_number }}', '{{ from_wh }}', '{{ to_wh }}')">-->
<!--                                                <i data-feather="maximize"></i> QR-->
<!--                                            </button>-->
<!--                                            <button class="btn btn-sm btn-info" onclick="generateIndividualTransferQRLabels({{ item.id }}, '{{ item.item_code }}', '{{ item.item_name }}')">-->
<!--                                                <i data-feather="grid"></i> Print {{ item.quantity|int }} Labels-->
<!--                                            </button>-->
                                            <button class="btn btn-sm btn-danger" onclick="removeItem({{ item.id }})">
                                                <i data-feather="trash-2"></i>
                                            </button>
                                        </div>
                                        {% else %}
<!--                                        <div class="btn-group">-->
<!--                                            {% set from_wh = item.from_bin.split('-')[0] if item.from_bin and '-' in item.from_bin else (item.from_bin[:4] if item.from_bin else 'N/A') %}-->
<!--                                            {% set to_wh = item.to_bin.split('-')[0] if item.to_bin and '-' in item.to_bin else (item.to_bin[:4] if item.to_bin else 'N/A') %}-->
<!--                                            <button class="btn btn-sm btn-success" onclick="generateTransferQRLabel('{{ item.item_code }}', '{{ item.item_name }}', '{{ item.batch_number or '' }}', {{ transfer.id }}, '{{ transfer.transfer_request_number }}', '{{ from_wh }}', '{{ to_wh }}')">-->
<!--                                                <i data-feather="maximize"></i> Print QR-->
<!--                                            </button>-->
<!--                                            <button class="btn btn-sm btn-info" onclick="generateIndividualTransferQRLabels({{ item.id }}, '{{ item.item_code }}', '{{ item.item_name }}')">-->
<!--                                                <i data-feather="grid"></i> Print {{ item.quantity|int }} Labels-->
<!--                                            </button>-->
<!--                                        </div>-->
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i data-feather="info"></i>
                        No items added to this transfer yet. Use the "Add Item" button to start adding items.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Available Items from Transfer Request (Similar to GRPO) -->
    {% if available_items %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i data-feather="list"></i> 
                        Available Items from Transfer Request
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Item Code</th>
                                    <th>Description</th>
                                    <th>Requested Qty</th>
                                    <th>Transferred</th>
                                    <th>Remaining</th>
                                    <th>UoM</th>
                                    <th>From Warehouse</th>
                                    <th>To Warehouse</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in available_items %}
                                <tr>
                                    <td><strong>{{ item.ItemCode or item.item_code }}</strong></td>
                                    <td>{{ item.ItemDescription or item.item_description or item.ItemName or item.item_name }}</td>
                                    <td>{{ item.Quantity or item.quantity }}</td>
                                    <td>
                                        <span class="badge bg-info">{{ item.TransferredQuantity or 0 }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if (item.RemainingQuantity or (item.Quantity or item.quantity)) > 0 else 'secondary' }}">
                                            {{ item.RemainingQuantity or (item.Quantity or item.quantity) }}
                                        </span>
                                    </td>
                                    <td>{{ item.UnitOfMeasure or item.unit_of_measure or item.UoM }}</td>
                                    <td>{{ item.FromWarehouseCode or item.from_warehouse_code or transfer.from_warehouse }}</td>
                                    <td>{{ item.ToWarehouseCode or item.to_warehouse_code or transfer.to_warehouse }}</td>
                                    <td>
                                        {% if item.LineStatus == 'bost_Close' %}
                                            <span class="badge bg-danger">Closed</span>
                                        {% elif item.LineStatus == 'bost_Open' %}
                                            <span class="badge bg-success">Open</span>
                                        {% else %}
                                            <span class="badge bg-warning">{{ item.LineStatus or 'Unknown' }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.LineStatus == 'bost_Close' %}
                                            <span class="badge bg-secondary">
                                                <i data-feather="lock"></i> Closed
                                            </span>
                                        {% elif (item.RemainingQuantity or (item.Quantity or item.quantity)) > 0 %}
                                        <button class="btn btn-sm btn-success" 
                                            onclick="addItemFromRequest('{{ item.ItemCode or item.item_code }}', 
                                                                        '{{ item.ItemDescription or item.item_description or item.ItemName or item.item_name }}', 
                                                                        '{{ item.RemainingQuantity or (item.Quantity or item.quantity) }}',
                                                                        '{{ item.UnitOfMeasure or item.unit_of_measure or item.UoM }}',
                                                                        '{{ item.FromWarehouseCode or item.from_warehouse_code or transfer.from_warehouse }}',
                                                                        '{{ item.ToWarehouseCode or item.to_warehouse_code or transfer.to_warehouse }}')">
                                            <i data-feather="plus"></i> Add Remaining
                                        </button>
                                        {% else %}
                                        <span class="badge bg-success">✓ Complete</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Actions -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('inventory_transfer') }}" class="btn btn-secondary">
                            <i data-feather="arrow-left"></i> Back to Transfer List
                        </a>
                        <div>
                            {% if transfer.status == 'draft' and transfer.items %}
                            <button class="btn btn-success" onclick="submitTransfer({{ transfer.id }})">
                                <i data-feather="check"></i> Submit for QC Approval
                            </button>
                            {% elif transfer.status == 'submitted' %}
                            <div class="alert alert-info mb-0">
                                <i data-feather="clock"></i>
                                Transfer submitted and waiting for QC approval. Only QC users can approve this transfer.
                            </div>
                            {% elif transfer.status == 'qc_approved' %}
                            <div class="alert alert-success mb-0">
                                <i data-feather="check-circle"></i>
                                Transfer QC approved and posted to SAP B1. SAP Document: {{ transfer.sap_document_number }}
                            </div>
                            {% elif transfer.status == 'rejected' %}
                            <div class="alert alert-danger mb-0">
                                <i data-feather="x-circle"></i>
                                Transfer rejected by QC. Reason: {{ transfer.qc_notes or 'No reason provided' }}
                                <br><br>
                                <button class="btn btn-warning btn-sm" onclick="reopenTransfer({{ transfer.id }})">
                                    <i data-feather="refresh-cw"></i> Reopen Transfer
                                </button>
                                <small class="text-muted d-block mt-2">Reopening will reset the transfer to draft status so you can edit and resubmit it.</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Item to Transfer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="handleModalClose()"></button>
            </div>
            <form id="addItemForm" method="POST" action="{{ url_for('inventory_transfer_detail', transfer_id=transfer.id) }}" onsubmit="return handleFormSubmit(event);">
                <div class="modal-body">
                    <div id="loading_indicator" class="alert alert-info" style="display: none;">
                        <i data-feather="loader"></i> Loading...
                    </div>
                    
                    <div class="alert alert-primary d-flex justify-content-between align-items-center">
                        <div>
                            <i data-feather="info"></i>
                            <strong>Quick Add:</strong> Scan GRN QR label to auto-fill all fields
                        </div>
                        <button type="button" class="btn btn-sm btn-success" onclick="showQRScanner()">
                            <i data-feather="maximize"></i> Scan QR Label
                        </button>
                    </div>
                    
                    <div class="mb-3">
                        <label for="item_code" class="form-label">Item Code <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="item_code" name="item_code" readonly>
                            <!-- <button type="button" class="btn btn-outline-primary" onclick="scanItemCode()">
                                <i data-feather="camera"></i> Scan
                            </button> -->
                        </div>
                        <div id="item_type_indicator" class="mt-2"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="item_name" class="form-label">Item Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="item_name" name="item_name" readonly>
                        <small class="text-muted">Auto-filled from SAP B1 when item is validated</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="from_warehouse_select" class="form-label">From Warehouse</label>
                        <select class="form-select" id="from_warehouse_select" onchange="onWarehouseChange()">
                            <option value="">Validate item code first</option>
                        </select>
                        <small class="text-muted">Warehouse list updates based on item type</small>
                    </div>
                    
                    <div class="mb-3" id="serial_number_group" style="display: none;">
                        <label for="serial_number" class="form-label">Serial Number <span class="text-danger">*</span></label>
                        <select class="form-select" id="serial_number" name="serial_number" onchange="onSerialNumberChange()">
                            <option value="">Select warehouse first</option>
                        </select>
                        <small class="text-muted">Serial numbers available in selected warehouse</small>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="quantity" class="form-label">Requested Quantity <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="quantity" name="quantity"  readonly>
                            </div>
                        </div>
                         <div class="col-md-4">
                            <div class="mb-3">
                                <label for="availabe_quantity" class="form-label">Available Quantity <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="availabe_quantity" name="quantity" step="1" readonly required>
                                <small class="text-muted">Scan QR labels to accumulate quantity</small>
                                <button type="button" class="btn btn-outline-primary" onclick="showQRScannerForTransfer()">
                                <i data-feather="camera"></i> Scan
                            </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="unit_of_measure" class="form-label">UoM <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="unit_of_measure" name="unit_of_measure" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="from_warehouse_code" class="form-label">From Warehouse <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="from_warehouse_code" name="from_warehouse_code" value="{{ transfer.from_warehouse or '' }}" readonly>
                                    <!-- <button type="button" class="btn btn-outline-primary" onclick="scanWarehouse('from')">
                                        <i data-feather="camera"></i> Scan
                                    </button> -->
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="to_warehouse_code" class="form-label">To Warehouse <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="to_warehouse_code" name="to_warehouse_code" value="{{ transfer.to_warehouse or '' }}" readonly>
                                    <!-- <button type="button" class="btn btn-outline-primary" onclick="scanWarehouse('to')">
                                        <i data-feather="camera"></i> Scan
                                    </button> -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="from_bin" class="form-label">From Bin Location <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <select class="form-select" id="from_bin" name="from_bin" >
                                        <option value="">Select warehouse first...</option>
                                    </select>
                                    <button type="button" class="btn btn-outline-primary" onclick="loadFromBinLocations()" id="from_bin_refresh_btn" style="display: none;">
                                        <i data-feather="refresh-cw"></i>
                                    </button>
                                </div>
                                <small class="text-muted" id="from_bin_status">Select from warehouse to load bin locations</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="to_bin" class="form-label">To Bin Location <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <select class="form-select" id="to_bin" name="to_bin" >
                                        <option value="">Select warehouse first...</option>
                                    </select>
                                    <button type="button" class="btn btn-outline-primary" onclick="loadToBinLocations()" id="to_bin_refresh_btn" style="display: none;">
                                        <i data-feather="refresh-cw"></i>
                                    </button>
                                </div>
                                <small class="text-muted" id="to_bin_status">Select to warehouse to load bin locations</small>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3" id="batch_number_group" style="display: none;">
                        <label for="batch_number" class="form-label">Batch Number</label>
                        <div class="input-group">
                            <select class="form-select" id="batch_number" name="batch_number" onchange="onBatchNumberChange()">
                                <option value="">Select warehouse first</option>
                            </select>
                            <button type="button" class="btn btn-outline-primary" onclick="loadBatchNumbers()">
                                <i data-feather="refresh-cw"></i> Refresh
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="showQRScannerForTransfer()">
                                <i data-feather="camera"></i> Scan
                            </button>
                        </div>
                        <small class="text-muted" id="batch_info">Select batch with available stock</small>
                    </div>
                    
                    <div id="scanned_packs_section" style="display: none;">
                        <div class="alert alert-info">
                            <h6><i data-feather="package"></i> Scanned Packs</h6>
                            <div id="scan_summary" class="mb-2">
                                <strong>Requested:</strong> <span id="requested_qty_display">0</span> |
                                <strong>Scanned:</strong> <span id="scanned_qty_display">0</span> |
                                <strong>Remaining:</strong> <span id="remaining_qty_display" class="text-primary">0</span>
                            </div>
                            <div id="scanned_packs_list" class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Pack</th>
                                            <th>Batch</th>
                                            <th>Qty</th>
                                            <th>Bin</th>
                                            <th>GRN</th>
                                            <th>Exp Date</th>
                                        </tr>
                                    </thead>
                                    <tbody id="scanned_packs_tbody">
                                    </tbody>
                                </table>
                            </div>
                            <button type="button" class="btn btn-sm btn-warning" onclick="resetScanState()">
                                <i data-feather="x"></i> Clear All Scans
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="handleModalClose()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Item</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showAddItemModal() {
    const modal = new bootstrap.Modal(document.getElementById('addItemModal'));
    modal.show();
}

function handleModalClose() {
    const itemCode = document.getElementById('item_code').value;
    if (itemCode) {
        resetScanStateForItem(itemCode);
    }
    
    document.getElementById('scanned_packs_section').style.display = 'none';
    document.getElementById('scanned_packs_tbody').innerHTML = '';
    document.getElementById('availabe_quantity').value = '';
    document.getElementById('item_code').value = '';
    document.getElementById('item_name').value = '';
    document.getElementById('batch_number_group').style.display = 'none';
}

function resetScanStateForItem(itemCode) {
    fetch('{{ url_for("inventory_transfer.api_reset_scan_state") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            transfer_id: {{ transfer.id }},
            item_code: itemCode
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('✅ Scan state cleared for item:', itemCode);
        }
    })
    .catch(error => {
        console.error('Error clearing scan state:', error);
    });
}

function scanBatchNumber() {
    // Implement barcode scanning for batch number
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        // Start barcode scanning
        alert('Barcode scanning feature would be implemented here for batch numbers');
    } else {
        alert('Camera not available for scanning');
    }
}

function addItemFromRequest(itemCode, itemName, quantity, uom, fromWarehouse, toWarehouse) {
    // Pre-fill the add item modal with data from the transfer request
    document.getElementById('item_code').value = itemCode;
    document.getElementById('item_name').value = itemName;
    document.getElementById('quantity').value = quantity;
    document.getElementById('unit_of_measure').value = uom;
    document.getElementById('from_warehouse_code').value = fromWarehouse;
    document.getElementById('to_warehouse_code').value = toWarehouse;

    // Load available batches for this item
    loadBatchNumbers();

    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('addItemModal'));
    modal.show();
}

function submitTransfer(transferId) {
    if (confirm('Are you sure you want to submit this transfer?')) {
        fetch(`/inventory_transfer/${transferId}/submit`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        console.log(response)
        .then(data => {
            if (data.success) {
                alert(`Transfer submitted successfully! SAP Document: ${data.sap_document_number}`);
                location.reload();
            } else {
                alert(`Error submitting transfer: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error submitting transfer');
        });
    }
}

function removeItem(itemId) {
    if (confirm('Are you sure you want to remove this item?')) {
        fetch(`/inventory_transfer/{{ transfer.id }}/item/${itemId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Item removed successfully');
                location.reload();
            } else {
                alert(`Error removing item: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error removing item');
        });
    }
}

function editItem(itemId, itemCode, itemName, quantity, uom, fromBin, toBin, batchNumber) {
    // Pre-fill the edit modal with current item data
    document.getElementById('item_code').value = itemCode || '';
    document.getElementById('item_name').value = itemName || '';
    document.getElementById('quantity').value = quantity || '';
    document.getElementById('unit_of_measure').value = uom || 'EA';
    document.getElementById('from_bin').value = fromBin || '';
    document.getElementById('to_bin').value = toBin || '';

    // Handle batch number textbox (changed from dropdown)
    const batchInput = document.getElementById('batch_number');
    batchInput.value = batchNumber || '';

    // Change form action to edit mode
    const form = document.getElementById('addItemForm');
    form.setAttribute('data-edit-mode', 'true');
    form.setAttribute('data-item-id', itemId);

    // Change modal title and button text
    document.querySelector('#addItemModal .modal-title').textContent = 'Edit Transfer Item';
    document.querySelector('#addItemForm button[type="submit"]').textContent = 'Update Item';

    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('addItemModal'));
    modal.show();
}

function handleFormSubmit(event) {
    const form = event.target;
    const isEditMode = form.getAttribute('data-edit-mode') === 'true';
    
    if (isEditMode) {
        event.preventDefault();
        
        const itemId = form.getAttribute('data-item-id');
        const formData = new FormData(form);
        
        const data = {
            quantity: formData.get('quantity'),
            from_bin: formData.get('from_bin'),
            to_bin: formData.get('to_bin'),
            batch_number: formData.get('batch_number')
        };
        
        fetch(`/inventory_transfer/{{ transfer.id }}/item/${itemId}/edit`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Item updated successfully');
                location.reload();
            } else {
                alert(`Error updating item: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating item');
        });
        
        return false;
    }
    
    return true; // Allow normal form submission for add mode
}

function reopenTransfer(transferId) {
    if (confirm('Are you sure you want to reopen this rejected transfer? This will reset it to draft status so you can edit and resubmit it.')) {
        fetch(`/inventory_transfer/${transferId}/reopen`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Transfer reopened successfully! You can now edit and resubmit it.');
                location.reload();
            } else {
                alert(`Error reopening transfer: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error reopening transfer');
        });
    }
}

// Reset modal when closed
document.getElementById('addItemModal').addEventListener('hidden.bs.modal', function () {
    const form = document.getElementById('addItemForm');
    form.removeAttribute('data-edit-mode');
    form.removeAttribute('data-item-id');
    form.reset();
    
    // Reset modal title and button text
    document.querySelector('#addItemModal .modal-title').textContent = 'Add Item to Transfer';
    document.querySelector('#addItemForm button[type="submit"]').textContent = 'Add Item';
});

// Enhanced scanning functionality for warehouse codes, items, and bins
function scanWarehouse(type) {
    // type can be 'from' or 'to'
    const inputId = type === 'from' ? 'from_warehouse_code' : 'to_warehouse_code';
    scanBarcode(inputId, function(code) {
        document.getElementById(inputId).value = code;
        alert(`${type.charAt(0).toUpperCase() + type.slice(1)} warehouse scanned: ${code}`);
    });
}

function scanBin(type) {
    // type can be 'from' or 'to'
    const inputId = type === 'from' ? 'from_bin' : 'to_bin';
    scanBarcode(inputId, function(code) {
        document.getElementById(inputId).value = code;
        alert(`${type.charAt(0).toUpperCase() + type.slice(1)} bin location scanned: ${code}`);
    });
}

function scanItemCode() {
    scanBarcode('item_code', function(code) {
        document.getElementById('item_code').value = code;
        
        // Validate item with SAP B1 and get item name
        fetch('/api/validate_item', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ item_code: code })
        })
        .then(response => response.json())
        .then(data => {
            if (data.valid) {
                document.getElementById('item_name').value = data.item_data.ItemName || code;
                document.getElementById('unit_of_measure').value = data.item_data.UoMEntry || 'EA';
                alert(`Item found: ${data.item_data.ItemName || code}`);
            } else {
                alert(`Item not found: ${data.error}`);
                document.getElementById('item_name').value = '';
            }
        })
        .catch(error => {
            console.error('Error validating item:', error);
            document.getElementById('item_name').value = code; // Fallback
        });
    });
}

function scanBarcode(targetInputId, callback) {
    // Check if we're in a mobile environment with camera access
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        // Use camera for scanning
        startCameraScanner(targetInputId, callback);
    } else {
        // Fallback to manual input
        const code = prompt('Enter barcode manually:');
        if (code) {
            callback(code);
        }
    }
}

// Generate Transfer QR Label
function generateTransferQRLabel(itemCode, itemName, batchNumber, transferId, transferNumber, fromWarehouse, toWarehouse) {
    const data = {
        item_code: itemCode,
        item_name: itemName,
        batch_number: batchNumber,
        transfer_id: transferId,
        transfer_number: transferNumber,
        from_warehouse: fromWarehouse || 'N/A',
        to_warehouse: toWarehouse || 'N/A'
    };
    
    fetch('/api/generate-transfer-qr-label', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Create and show QR code modal for transfer
            showTransferQRCodeModal(data.qr_data, data.label_info);
        } else {
            alert('Error generating QR label: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error generating QR label');
    });
}

// Show Transfer QR Code Modal
function showTransferQRCodeModal(qrData, labelInfo) {
    // Create modal if it doesn't exist
    let modal = document.getElementById('transferQrCodeModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.innerHTML = `
            <div class="modal fade" id="transferQrCodeModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Transfer QR Code Label</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <div id="transferQrcode"></div>
                            <div class="mt-3">
                                <p><strong>Item Code:</strong> <span id="transfer-qr-item-code"></span></p>
                                <p><strong>Transfer Number:</strong> <span id="transfer-qr-number"></span></p>
                                <p><strong>Item Name:</strong> <span id="transfer-qr-item-name"></span></p>
                                <p><strong>From Warehouse:</strong> <span id="transfer-qr-from-warehouse"></span></p>
                                <p><strong>To Warehouse:</strong> <span id="transfer-qr-to-warehouse"></span></p>
                                <p><strong>Batch Number:</strong> <span id="transfer-qr-batch-number"></span></p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="printTransferQRLabel()">Print Label</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    // Update modal content
    document.getElementById('transfer-qr-item-code').textContent = labelInfo.item_code;
    document.getElementById('transfer-qr-number').textContent = labelInfo.transfer_number;
    document.getElementById('transfer-qr-item-name').textContent = labelInfo.item_name;
    document.getElementById('transfer-qr-from-warehouse').textContent = labelInfo.from_warehouse || 'N/A';
    document.getElementById('transfer-qr-to-warehouse').textContent = labelInfo.to_warehouse || 'N/A';
    document.getElementById('transfer-qr-batch-number').textContent = labelInfo.batch_number || 'N/A';
    
    // Generate QR code
    const qrCodeDiv = document.getElementById('transferQrcode');
    qrCodeDiv.innerHTML = '';
    
    // Load QRCode library if not already loaded
    if (typeof QRCode === 'undefined') {
        const script = document.createElement('script');

        script.onload = function() {
            generateTransferQRCode(qrCodeDiv, qrData);
        };
        document.head.appendChild(script);
    } else {
        generateTransferQRCode(qrCodeDiv, qrData);
    }
    
    // Show modal
    const bsModal = new bootstrap.Modal(document.getElementById('transferQrCodeModal'));
    bsModal.show();
}

// Generate Transfer QR Code
function generateTransferQRCode(container, data) {
    try {
        QRCode.toCanvas(data, { width: 200, height: 200 }, function (error, canvas) {
            if (error) {
                console.error('QR Code generation error:', error);
                container.innerHTML = '<p class="text-danger">Error generating QR code</p>';
            } else {
                container.innerHTML = '';
                container.appendChild(canvas);
            }
        });
    } catch (error) {
        console.error('QR Code library error:', error);
        container.innerHTML = '<p class="text-info">QR Code: ' + data + '</p>';
    }
}

// Print Transfer QR Label
function printTransferQRLabel() {
    window.print();
}

// Generate QR Label for Transfer Items
function generateTransferQRLabel(itemCode, itemName, batchNumber, transferId, transferNumber) {
    const data = {
        item_code: itemCode,
        item_name: itemName,
        batch_number: batchNumber,
        transfer_id: transferId,
        transfer_number: transferNumber
    };
    
    fetch('/api/generate-transfer-qr-label', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Create and show QR code modal
            showTransferQRCodeModal(data.qr_data, data.label_info);
        } else {
            alert('Error generating QR label: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error generating QR label');
    });
}

// Show Transfer QR Code Modal
function showTransferQRCodeModal(qrData, labelInfo) {
    // Create modal if it doesn't exist
    let modal = document.getElementById('transferQrCodeModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.innerHTML = `
            <div class="modal fade" id="transferQrCodeModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Transfer QR Code Label</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <div id="transferQrcode"></div>
                            <div class="mt-3">
                                <p><strong>Item Code:</strong> <span id="transfer-qr-item-code"></span></p>
                                <p><strong>Transfer Number:</strong> <span id="transfer-qr-transfer-number"></span></p>
                                <p><strong>Item Name:</strong> <span id="transfer-qr-item-name"></span></p>
                                <p><strong>Batch Number:</strong> <span id="transfer-qr-batch-number"></span></p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="printTransferQRLabel()">Print Label</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    // Update modal content
    document.getElementById('transfer-qr-item-code').textContent = labelInfo.item_code;
    document.getElementById('transfer-qr-transfer-number').textContent = labelInfo.transfer_number;
    document.getElementById('transfer-qr-item-name').textContent = labelInfo.item_name;
    document.getElementById('transfer-qr-batch-number').textContent = labelInfo.batch_number || 'N/A';
    
    // Generate QR code using QRCode.js library
    const qrCodeDiv = document.getElementById('transferQrcode');
    qrCodeDiv.innerHTML = '';
    
    // Load QRCode library if not already loaded
    if (typeof QRCode === 'undefined') {
        const script = document.createElement('script');

        script.onload = function() {
            generateTransferQRCode(qrCodeDiv, qrData);
        };
        document.head.appendChild(script);
    } else {
        generateTransferQRCode(qrCodeDiv, qrData);
    }
    
    // Show modal
    const bsModal = new bootstrap.Modal(document.getElementById('transferQrCodeModal'));
    bsModal.show();
}

// Generate Transfer QR Code
function generateTransferQRCode(container, data) {
    try {
        QRCode.toCanvas(data, { width: 200, height: 200 }, function (error, canvas) {
            if (error) {
                console.error('QR Code generation error:', error);
                container.innerHTML = '<p class="text-danger">Error generating QR code</p>';
            } else {
                container.innerHTML = '';
                container.appendChild(canvas);
            }
        });
    } catch (error) {
        console.error('QR Code library error:', error);
        container.innerHTML = '<p class="text-info">QR Code: ' + data + '</p>';
    }
}

// Print Transfer QR Label
function printTransferQRLabel() {
    window.print();
}

function startCameraScanner(targetInputId, callback) {
    // This would integrate with QuaggaJS or similar barcode scanner
    // For now, we'll use a simple prompt as fallback
    const code = prompt('Camera scanner not available. Enter barcode manually:');
    if (code) {
        callback(code);
    }
}

// Auto-populate warehouse codes from transfer request when modal opens
document.getElementById('addItemModal').addEventListener('show.bs.modal', function () {
    const fromWarehouse = document.getElementById('from_warehouse_code').value;
    const toWarehouse = document.getElementById('to_warehouse_code').value;
    
    // Pre-fill warehouse codes in form if available
    if (fromWarehouse) {
        document.getElementById('from_warehouse_code').value = fromWarehouse;
    }
    if (toWarehouse) {
        document.getElementById('to_warehouse_code').value = toWarehouse;
    }
});

// Batch number management functions
function loadBatchNumbers() {
    const itemCode = document.getElementById('item_code').value;
    const fromWarehouse = document.getElementById('from_warehouse_code').value;
    const batchSelect = document.getElementById('batch_number');
    const batchInfo = document.getElementById('batch_info');
    
    if (!itemCode) {
        batchSelect.innerHTML = '<option value="">Select item first</option>';
        batchInfo.textContent = 'Enter item code to load available batches';
        return;
    }
    
    batchSelect.innerHTML = '<option value="">Loading batches...</option>';
    batchInfo.textContent = 'Loading available batches...';
    fetch(`/api/get-batches?item=${itemCode}`)
    .then(response => response.json())
    .then(data => {
        const batchSelect = document.getElementById('batch_number');
        const batchInfo = document.getElementById('batch_info');
        batchSelect.innerHTML = '';

  if (data.success && data.batches && data.batches.length > 0) {

                data.batches.forEach(batch => {
                    const option = document.createElement('option');
                    option.value = batch.Batch || batch.BatchNumber;
                    option.textContent = `${batch.Batch || batch.BatchNumber} , Exp: ${batch.ExpirationDate || batch.ExpiryDate || 'N/A'}`;
                    option.setAttribute('data-expiry', batch.ExpirationDate || batch.ExpiryDate);
                    batchSelect.appendChild(option);
                });

            batchInfo.textContent = `Found ${data.batches.length} available batches`;
        } else {
            batchSelect.innerHTML = '<option value="">No batches available</option>';
            batchInfo.textContent = 'No batches found or item is not batch managed';
        }
    })
    .catch(error => {
        console.error('Error loading batches:', error);
        batchSelect.innerHTML = '<option value="">Error loading batches</option>';
        batchInfo.textContent = 'Error loading batches. Check connection.';
    });
}

function refreshBatches() {
    loadBatchNumbers();
}

<!--function validateBatchQuantity() {-->
<!--    const itemCode = document.getElementById('item_code').value;-->
<!--    const batchNumber = document.getElementById('batch_number').value;-->
<!--    const warehouse = document.getElementById('from_warehouse_code').value;-->
<!--    const quantity = parseFloat(document.getElementById('quantity').value) || 0;-->
<!--    -->
<!--    if (!itemCode || !batchNumber || quantity <= 0) {-->
<!--        return;-->
<!--    }-->
<!--    -->
<!--    fetch(`/api/validate_batch_quantity?item_code=${itemCode}&batch_number=${batchNumber}&warehouse=${warehouse}&quantity=${quantity}`)-->
<!--        .then(response => response.json())-->
<!--        .then(data => {-->
<!--            const batchInfo = document.getElementById('batch_info');-->
<!--            -->
<!--            if (data.success) {-->
<!--                if (data.valid) {-->
<!--                    batchInfo.innerHTML = `<span class="text-success">✓ Quantity OK (Available: ${data.available_quantity})</span>`;-->
<!--                } else {-->
<!--                    batchInfo.innerHTML = `<span class="text-danger">⚠ Insufficient stock (Available: ${data.available_quantity}, Requested: ${data.requested_quantity})</span>`;-->
<!--                }-->
<!--            } else {-->
<!--                batchInfo.innerHTML = `<span class="text-warning">Could not validate batch quantity</span>`;-->
<!--            }-->
<!--        })-->
<!--        .catch(error => {-->
<!--            console.error('Error validating batch quantity:', error);-->
<!--        });-->
<!--}-->

// Add event listeners for real-time validation
<!--document.addEventListener('DOMContentLoaded', function() {-->
<!--    const quantityInput = document.getElementById('quantity');-->
<!--    const batchSelect = document.getElementById('batch_number');-->
<!--    -->
<!--    if (quantityInput) {-->
<!--        quantityInput.addEventListener('blur', validateBatchQuantity);-->
<!--        quantityInput.addEventListener('input', debounce(validateBatchQuantity, 500));-->
<!--    }-->
<!--    -->
<!--    if (batchSelect) {-->
<!--        batchSelect.addEventListener('change', validateBatchQuantity);-->
<!--    }-->
<!--});-->

// Debounce helper function
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Individual QR Labels Generation for Transfer Items
<!--function generateIndividualTransferQRLabels(itemId, itemCode, itemName) {-->
<!--    console.log(`Generating individual QR labels for transfer item ${itemId}`);-->
<!--    -->
<!--    fetch(`/inventory_transfer/items/${itemId}/generate-qr-labels`)-->
<!--        .then(response => {-->
<!--            if (!response.ok) {-->
<!--                throw new Error(`HTTP error! status: ${response.status}`);-->
<!--            }-->
<!--            return response.json();-->
<!--        })-->
<!--        .then(data => {-->
<!--            if (!data.success || !data.labels || data.labels.length === 0) {-->
<!--                alert('No labels to generate for this item');-->
<!--                return;-->
<!--            }-->
<!--            -->
<!--            const labels = data.labels;-->
<!--            const modal = new bootstrap.Modal(document.getElementById('transferIndividualQRLabelsModal'));-->
<!--            const container = document.getElementById('transferIndividualQRLabelsContainer');-->
<!--            container.innerHTML = '';-->
<!--            -->
<!--            // Wait for QRCode library then generate codes-->
<!--            waitForQRCodeTransfer((loaded) => {-->
<!--                labels.forEach((label, index) => {-->
<!--                    const qrDiv = document.createElement('div');-->
<!--                    qrDiv.className = 'qr-label-item col-md-6 mb-3';-->
<!--                    -->
<!--                    const qrData = `TRANSFER:${label.item_code}|${label.transfer_number}|FROM:${label.from_warehouse}|TO:${label.to_warehouse}|UNIT:${label.unit_number}/${label.total_units}${label.batch_number ? '|BATCH:' + label.batch_number : ''}`;-->
<!--                    -->
<!--                    qrDiv.innerHTML = `-->
<!--                        <div class="text-center p-3 border rounded">-->
<!--                            <h6>${label.item_code} - ${label.item_name}</h6>-->
<!--                            <div class="qr-code-container mb-2"></div>-->
<!--                            <p class="mb-1"><strong>Transfer: ${label.transfer_number}</strong></p>-->
<!--                            <p class="mb-1"><strong>From: ${label.from_warehouse}</strong> (${label.from_bin})</p>-->
<!--                            <p class="mb-1"><strong>To: ${label.to_warehouse}</strong> (${label.to_bin})</p>-->
<!--                            ${label.batch_number ? `<p class="mb-1">Batch: ${label.batch_number}</p>` : ''}-->
<!--                            <p class="mb-0">Unit ${label.unit_number} of ${label.total_units}</p>-->
<!--                        </div>-->
<!--                    `;-->
<!--                    container.appendChild(qrDiv);-->
<!--                    -->
<!--                    // Get QR container for code generation-->
<!--                    const qrContainer = qrDiv.querySelector('.qr-code-container');-->
<!--                    -->
<!--                    // Generate QR code using qrcodejs-->
<!--                    if (loaded && typeof QRCode !== 'undefined') {-->
<!--                        try {-->
<!--                            new QRCode(qrContainer, {-->
<!--                                text: qrData,-->
<!--                                width: 200,-->
<!--                                height: 200,-->
<!--                                colorDark: '#000000',-->
<!--                                colorLight: '#ffffff',-->
<!--                                correctLevel: QRCode.CorrectLevel.H-->
<!--                            });-->
<!--                        } catch (error) {-->
<!--                            console.error('QR generation error:', error);-->
<!--                            qrContainer.innerHTML = `<p class="text-danger">Error generating QR: ${error.message}</p>`;-->
<!--                        }-->
<!--                    } else {-->
<!--                        qrContainer.innerHTML = `<p class="text-danger">QR library not loaded. Please do a hard refresh (Ctrl+Shift+R)</p>`;-->
<!--                    }-->
<!--                });-->
<!--                -->
<!--                modal.show();-->
<!--            });-->
<!--        })-->
<!--        .catch(error => {-->
<!--            console.error('Error fetching transfer item for QR labels:', error);-->
<!--            alert(`Error loading QR labels: ${error.message}\n\nPlease check:\n1. Item exists\n2. You are logged in\n3. Check browser console for details`);-->
<!--        });-->
<!--}-->

// Wait for QRCode library to load (for transfer)
function waitForQRCodeTransfer(callback, timeout = 5000) {
    console.log('Waiting for QRCode library...');
    console.log('QRCode available:', typeof QRCode !== 'undefined');
    
    const startTime = Date.now();
    const checkInterval = setInterval(() => {
        if (typeof QRCode !== 'undefined') {
            console.log('✅ QRCode library loaded successfully!');
            clearInterval(checkInterval);
            callback(true);
        } else if (Date.now() - startTime > timeout) {
            console.error('❌ QRCode library failed to load after 5 seconds');
            console.error('Please do a hard refresh: Ctrl+Shift+R (Windows) or Cmd+Shift+R (Mac)');
            clearInterval(checkInterval);
            callback(false);
        }
    }, 100);
}

// Print all transfer individual QR labels
function printAllTransferQRLabels() {
    const container = document.getElementById('transferIndividualQRLabelsContainer');
    const printWindow = window.open('', '_blank', 'width=800,height=600');
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Print Transfer QR Labels</title>
            <style>
                @media print {
                    body { margin: 0; }
                    .qr-label-item { page-break-inside: avoid; }
                }
                body {
                    font-family: Arial, sans-serif;
                    padding: 20px;
                }
                .qr-label-item {
                    display: inline-block;
                    width: 45%;
                    margin: 10px;
                    padding: 15px;
                    border: 2px solid #000;
                    text-align: center;
                    vertical-align: top;
                }
                .qr-label-item h6 {
                    font-size: 14px;
                    margin-bottom: 10px;
                }
                .qr-label-item p {
                    font-size: 11px;
                    margin: 3px 0;
                }
                .qr-label-item img, .qr-label-item canvas {
                    max-width: 100%;
                    height: auto;
                }
            </style>
        </head>
        <body>
            ${container.innerHTML}
        </body>
        </html>
    `);
    
    printWindow.document.close();
    setTimeout(() => {
        printWindow.print();
        printWindow.close();
    }, 500);
}
</script>

<!-- Individual QR Labels Modal -->
<div class="modal fade" id="transferIndividualQRLabelsModal" tabindex="-1" aria-labelledby="transferIndividualQRLabelsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transferIndividualQRLabelsModalLabel"># QR Code Labels</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="transferIndividualQRLabelsContainer" class="row">
                    <!-- QR codes will be generated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="printAllTransferQRLabels()">
                    <i data-feather="printer"></i> Print All Labels
                </button>
            </div>
        </div>
    </div>
</div>

<!-- QR Scanner Modal for Item Code -->
<div class="modal fade" id="qrScannerModal" tabindex="-1" aria-labelledby="qrScannerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="qrScannerModalLabel">
                    <i data-feather="camera"></i> Scan QR Label
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i data-feather="info"></i>
                    <strong>Scan GRN QR Label</strong>: Position the QR code in front of the camera or upload an image
                </div>
                
                <div class="d-flex gap-3 mb-3">
                    <button type="button" class="btn btn-primary flex-fill" id="startCameraScanBtn">
                        <i data-feather="camera"></i> Use Camera
                    </button>
                    <button type="button" class="btn btn-secondary flex-fill" id="uploadQRBtn">
                        <i data-feather="upload"></i> Upload QR Image
                    </button>
                </div>
                
                <input type="file" id="qrFileInput" accept="image/*" style="display: none;">
                
                <div id="qrReaderContainer" style="display: none;">
                    <div id="qr-reader" style="width: 100%; min-height: 300px;"></div>
                </div>
                
                <div id="qrScanResult" class="mt-3" style="display: none;">
                    <div class="alert alert-success">
                        <h6>QR Code Scanned Successfully!</h6>
                        <pre id="qrDataDisplay" class="mb-0 mt-2" style="font-size: 12px; background: #f8f9fa; padding: 10px; border-radius: 5px;"></pre>
                    </div>
                </div>
                
                <div id="qrScanError" class="mt-3" style="display: none;">
                    <div class="alert alert-danger">
                        <h6>Scan Error</h6>
                        <p id="qrErrorMessage" class="mb-0"></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
let html5QrCode = null;

function showQRScanner() {
    const modal = new bootstrap.Modal(document.getElementById('qrScannerModal'));
    modal.show();
    
    document.getElementById('qrReaderContainer').style.display = 'none';
    document.getElementById('qrScanResult').style.display = 'none';
    document.getElementById('qrScanError').style.display = 'none';
}

document.getElementById('startCameraScanBtn').addEventListener('click', function() {
    startCameraQRScan();
});

document.getElementById('uploadQRBtn').addEventListener('click', function() {
    document.getElementById('qrFileInput').click();
});

document.getElementById('qrFileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        scanQRFromFile(file);
    }
});

function startCameraQRScan() {
    document.getElementById('qrReaderContainer').style.display = 'block';
    document.getElementById('qrScanResult').style.display = 'none';
    document.getElementById('qrScanError').style.display = 'none';
    
    if (!html5QrCode) {
        html5QrCode = new Html5Qrcode("qr-reader");
    }
    
    const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 }
    };
    
    html5QrCode.start(
        { facingMode: "environment" },
        config,
        onQRScanSuccess,
        onQRScanError
    ).catch(err => {
        console.error('Camera start error:', err);
        showQRError('Failed to start camera: ' + err.message);
    });
}

function scanQRFromFile(file) {
    if (!html5QrCode) {
        html5QrCode = new Html5Qrcode("qr-reader");
    }
    
    document.getElementById('qrScanResult').style.display = 'none';
    document.getElementById('qrScanError').style.display = 'none';
    
    html5QrCode.scanFile(file, true)
        .then(decodedText => {
            onQRScanSuccess(decodedText);
        })
        .catch(err => {
            console.error('File scan error:', err);
            showQRError('Failed to scan QR code from image: ' + err.message);
        });
}

function onQRScanSuccess(decodedText) {
    console.log('QR Code decoded:', decodedText);
    
    if (html5QrCode && html5QrCode.isScanning) {
        html5QrCode.stop();
    }
    
    document.getElementById('qrDataDisplay').textContent = decodedText;
    document.getElementById('qrScanResult').style.display = 'block';
    document.getElementById('qrScanError').style.display = 'none';
    
    try {
        const qrData = JSON.parse(decodedText);
        processQRData(qrData);
    } catch (e) {
        console.error('JSON parse error:', e);
        showQRError('QR code does not contain valid JSON data. Scanned text: ' + decodedText);
    }
}

function onQRScanError(error) {
    console.warn('QR scan error (normal during scanning):', error);
}

function showQRError(message) {
    document.getElementById('qrErrorMessage').textContent = message;
    document.getElementById('qrScanError').style.display = 'block';
    document.getElementById('qrScanResult').style.display = 'none';
}

function processQRData(qrData) {
    console.log('Processing QR data:', qrData);
    
    const itemCode = qrData.item || qrData.item_code || '';
    const batchNumber = qrData.batch || qrData.batch_number || '';
    const serialNumber = qrData.serial || qrData.serial_number || '';
    const quantity = qrData.qty || qrData.quantity || 1;
    const expiryDate = qrData.exp_date || qrData.expiry_date || '';
    
    const qrModal = bootstrap.Modal.getInstance(document.getElementById('qrScannerModal'));
    if (qrModal) {
        qrModal.hide();
    }
    
    setTimeout(() => {
        const addItemModal = new bootstrap.Modal(document.getElementById('addItemModal'));
        addItemModal.show();
        
        const itemCodeField = document.getElementById('item_code');
        if (itemCodeField && itemCode) {
            itemCodeField.value = itemCode;
            
            const quantityField = document.getElementById('quantity');
            if (quantityField) {
                quantityField.value = quantity;
            }
            
            if (typeof validateItemCodeFromSAP === 'function') {
                validateItemCodeFromSAP(itemCode, function(success) {
                    if (success && batchNumber) {
                        setTimeout(() => {
                            const batchField = document.getElementById('batch_number');
                            if (batchField && batchField.options.length > 1) {
                                const batchOption = Array.from(batchField.options).find(
                                    opt => opt.text.includes(batchNumber)
                                );
                                if (batchOption) {
                                    batchField.value = batchOption.value;
                                    batchField.dispatchEvent(new Event('change'));
                                }
                            }
                        }, 1500);
                    }
                    
                    if (success && serialNumber) {
                        setTimeout(() => {
                            const serialField = document.getElementById('serial_number');
                            if (serialField && serialField.options.length > 1) {
                                const serialOption = Array.from(serialField.options).find(
                                    opt => opt.text.includes(serialNumber) || opt.value === serialNumber
                                );
                                if (serialOption) {
                                    serialField.value = serialOption.value;
                                    serialField.dispatchEvent(new Event('change'));
                                }
                            }
                        }, 1500);
                    }
                });
            } else {
                console.warn('validateItemCodeFromSAP function not found, falling back to blur event');
                itemCodeField.dispatchEvent(new Event('blur'));
            }
        }
        
        feather.replace();
    }, 300);
}

document.getElementById('qrScannerModal').addEventListener('hidden.bs.modal', function () {
    stopQRScanner();
});

function stopQRScanner() {
    if (html5QrCode) {
        if (html5QrCode.isScanning) {
            html5QrCode.stop()
                .then(() => {
                    console.log('QR scanner stopped successfully');
                    html5QrCode.clear();
                })
                .catch(err => {
                    console.error('Error stopping scanner:', err);
                    try {
                        html5QrCode.clear();
                    } catch (clearErr) {
                        console.error('Error clearing scanner:', clearErr);
                    }
                });
        }
    }
    
    document.getElementById('qrReaderContainer').style.display = 'none';
    document.getElementById('qrScanResult').style.display = 'none';
    document.getElementById('qrScanError').style.display = 'none';
    document.getElementById('qrFileInput').value = '';
}

// QR Scanner for Inventory Transfer
function showQRScannerForTransfer() {
    const modal = new bootstrap.Modal(document.getElementById('qrScannerModal'));
    modal.show();
    
    setTimeout(() => {
        startQRScannerForTransfer();
    }, 500);
}

function startQRScannerForTransfer() {
    const qrReaderContainer = document.getElementById('qrReaderContainer');
    const qrScanResult = document.getElementById('qrScanResult');
    const qrScanError = document.getElementById('qrScanError');
    
    qrReaderContainer.style.display = 'block';
    qrScanResult.style.display = 'none';
    qrScanError.style.display = 'none';
    
    if (!html5QrCode) {
        html5QrCode = new Html5Qrcode("qr-reader");
    }
    
    const config = { fps: 10, qrbox: { width: 250, height: 250 } };
    
    html5QrCode.start(
        { facingMode: "environment" },
        config,
        (decodedText, decodedResult) => {
            console.log(`QR Code scanned: ${decodedText}`);
            processScannedQRLabel(decodedText);
            stopQRScanner();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('qrScannerModal'));
            modal.hide();
        },
        (errorMessage) => {
            // Scanning errors are normal, ignore them
        }
    ).catch(err => {
        console.error('Error starting QR scanner:', err);
        qrScanError.textContent = 'Failed to start camera. Please check camera permissions.';
        qrScanError.style.display = 'block';
    });
}

function processScannedQRLabel(qrData) {
    console.log('Processing scanned QR label:', qrData);
    
    const loadingIndicator = document.getElementById('loading_indicator');
    if (loadingIndicator) {
        loadingIndicator.style.display = 'block';
    }
    
    const requestedQty = parseFloat(document.getElementById('quantity').value) || 0;
    const targetItemCode = document.getElementById('item_code').value || '';
    
    fetch('{{ url_for("inventory_transfer.api_scan_qr_label") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            qr_data: qrData,
            transfer_id: {{ transfer.id }},
            requested_qty: requestedQty,
            target_item_code: targetItemCode
        })
    })
    .then(response => response.json())
    .then(data => {
        if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
        }
        
        if (data.success) {
            console.log('✅ QR scan successful:', data);
            
            populateAddItemModalFromQR(data);
            
            showAlert('success', data.message || 'QR label scanned successfully!');
            
            if (data.is_complete) {
                showAlert('success', `✅ All packs scanned! Total: ${data.total_scanned_qty}/${data.requested_qty}`);
            }
        } else {
            console.error('❌ QR scan failed:', data.error);
            showAlert('danger', data.error || 'Failed to process QR label');
        }
    })
    .catch(error => {
        if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
        }
        console.error('Error processing QR label:', error);
        showAlert('danger', 'Error processing QR label: ' + error.message);
    });
}

function populateAddItemModalFromQR(scanData) {
    if (scanData.item_code) {
        const itemCodeField = document.getElementById('item_code');
        if (itemCodeField && !itemCodeField.value) {
            itemCodeField.value = scanData.item_code;
            
            setTimeout(() => {
                if (typeof validateItemCodeFromSAP === 'function') {
                    validateItemCodeFromSAP();
                }
            }, 300);
        }
    }
    
    if (scanData.scanned_packs && scanData.scanned_packs.length > 0) {
        renderScannedPacks(scanData);
        
        const availableQtyField = document.getElementById('availabe_quantity');
        if (availableQtyField) {
            availableQtyField.value = scanData.total_scanned_qty || 0;
        }
        
        if (scanData.latest_bin_location) {
            const fromBinSelect = document.getElementById('from_bin');
            if (fromBinSelect) {
                let binFound = false;
                for (let option of fromBinSelect.options) {
                    if (option.value === scanData.latest_bin_location) {
                        option.selected = true;
                        binFound = true;
                        break;
                    }
                }
                if (!binFound && fromBinSelect.options.length > 0) {
                    const newOption = document.createElement('option');
                    newOption.value = scanData.latest_bin_location;
                    newOption.textContent = scanData.latest_bin_location + ' (from QR)';
                    newOption.selected = true;
                    fromBinSelect.appendChild(newOption);
                }
                console.log('✅ Auto-selected From Bin Location:', scanData.latest_bin_location);
            }
        }
        
        const uniqueBatches = [...new Set(scanData.scanned_packs.map(p => p.batch_number).filter(b => b))];
        
        if (uniqueBatches.length > 0) {
            const batchSelect = document.getElementById('batch_number');
            if (batchSelect) {
                batchSelect.innerHTML = '<option value="">Select batch</option>';
                
                uniqueBatches.forEach(batch => {
                    const option = document.createElement('option');
                    option.value = batch;
                    const packInfo = scanData.scanned_packs.filter(p => p.batch_number === batch);
                    const totalQty = packInfo.reduce((sum, p) => sum + (p.qty || 0), 0);
                    const expDate = packInfo[0].exp_date || 'N/A';
                    option.textContent = `${batch}, Qty: ${totalQty}, Exp: ${expDate}`;
                    if (uniqueBatches.length === 1) {
                        option.selected = true;
                    }
                    batchSelect.appendChild(option);
                });
                
                const batchGroup = document.getElementById('batch_number_group');
                if (batchGroup) {
                    batchGroup.style.display = 'block';
                }
            }
        }
        
        if (scanData.batch_summary) {
            window.scannedBatchSummary = scanData.batch_summary;
            console.log('✅ Stored batch summary for SAP posting:', scanData.batch_summary);
        }
    }
    
    const modal = document.getElementById('addItemModal');
    if (modal && !bootstrap.Modal.getInstance(modal)) {
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();
    }
}

function renderScannedPacks(scanData) {
    const scannedPacksSection = document.getElementById('scanned_packs_section');
    const tbody = document.getElementById('scanned_packs_tbody');
    
    if (!scannedPacksSection || !tbody) {
        console.warn('Scanned packs UI elements not found');
        return;
    }
    
    scannedPacksSection.style.display = 'block';
    
    document.getElementById('requested_qty_display').textContent = scanData.requested_qty || 0;
    document.getElementById('scanned_qty_display').textContent = scanData.total_scanned_qty || 0;
    document.getElementById('remaining_qty_display').textContent = scanData.remaining_qty || 0;
    
    tbody.innerHTML = '';
    
    if (scanData.scanned_packs && scanData.scanned_packs.length > 0) {
        scanData.scanned_packs.forEach(pack => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${pack.pack_label || '-'}</td>
                <td><span class="badge bg-primary">${pack.batch_number || '-'}</span></td>
                <td><strong>${pack.qty || 0}</strong></td>
                <td><span class="badge bg-info">${pack.bin_location || '-'}</span></td>
                <td><small>${pack.grn_id || '-'}</small></td>
                <td><small>${pack.exp_date || '-'}</small></td>
            `;
            tbody.appendChild(row);
        });
    }
    
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
}

function resetScanState() {
    if (!confirm('Clear all scanned packs? This cannot be undone.')) {
        return;
    }
    
    fetch('{{ url_for("inventory_transfer.api_reset_scan_state") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            transfer_id: {{ transfer.id }},
            item_code: document.getElementById('item_code').value || null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('scanned_packs_section').style.display = 'none';
            document.getElementById('scanned_packs_tbody').innerHTML = '';
            document.getElementById('quantity').value = '';
            
            showAlert('success', 'Scan state cleared successfully');
        } else {
            showAlert('danger', 'Error clearing scan state: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error resetting scan state:', error);
        showAlert('danger', 'Error clearing scan state: ' + error.message);
    });
}

function showAlert(type, message) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    const container = document.querySelector('.container-fluid');
    if (container) {
        const alertDiv = document.createElement('div');
        alertDiv.innerHTML = alertHtml;
        container.insertBefore(alertDiv.firstElementChild, container.firstChild);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            const alert = container.querySelector('.alert');
            if (alert) {
                alert.remove();
            }
        }, 5000);
    }
}

// Bin Location Management
const binLocationCache = {};

// Load bin locations for from warehouse
function loadFromBinLocations() {
    const warehouseCode = document.getElementById('from_warehouse_code').value;
    if (!warehouseCode) {
        document.getElementById('from_bin_status').textContent = 'Select from warehouse first';
        return;
    }
    
    loadBinLocations(warehouseCode, 'from');
}

// Load bin locations for to warehouse
function loadToBinLocations() {
    const warehouseCode = document.getElementById('to_warehouse_code').value;
    if (!warehouseCode) {
        document.getElementById('to_bin_status').textContent = 'Select to warehouse first';
        return;
    }
    
    loadBinLocations(warehouseCode, 'to');
}

// Generic function to load bin locations from SAP B1
function loadBinLocations(warehouseCode, type) {
    const selectId = type === 'from' ? 'from_bin' : 'to_bin';
    const statusId = type === 'from' ? 'from_bin_status' : 'to_bin_status';
    const refreshBtnId = type === 'from' ? 'from_bin_refresh_btn' : 'to_bin_refresh_btn';
    const select = document.getElementById(selectId);
    const status = document.getElementById(statusId);
    const refreshBtn = document.getElementById(refreshBtnId);
    
    // Check cache first
    if (binLocationCache[warehouseCode]) {
        populateBinDropdown(select, binLocationCache[warehouseCode], statusId, refreshBtnId);
        return;
    }
    
    // Show loading state
    select.disabled = true;
    status.textContent = 'Loading bin locations...';
    status.className = 'text-muted';
    
    // Fetch from API
    fetch(`/inventory_transfer/api/bin-locations?warehouse_code=${encodeURIComponent(warehouseCode)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Cache the results
                binLocationCache[warehouseCode] = data.bins;
                populateBinDropdown(select, data.bins, statusId, refreshBtnId);
            } else {
                select.disabled = false;
                select.innerHTML = '<option value="">Error loading bins</option>';
                status.textContent = data.error || 'Failed to load bin locations';
                status.className = 'text-danger';
                showAlert('danger', `Failed to load bin locations: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Error loading bin locations:', error);
            select.disabled = false;
            select.innerHTML = '<option value="">Error loading bins</option>';
            status.textContent = 'Error connecting to server';
            status.className = 'text-danger';
            showAlert('danger', `Error loading bin locations: ${error.message}`);
        });
}

// Populate bin dropdown with fetched data
function populateBinDropdown(select, bins, statusId, refreshBtnId) {
    const status = document.getElementById(statusId);
    const refreshBtn = document.getElementById(refreshBtnId);
    
    select.disabled = false;
    select.innerHTML = '<option value="">Select bin location...</option>';
    
    if (bins && bins.length > 0) {
        bins.forEach(bin => {
            const option = document.createElement('option');
            option.value = bin.BinCode;
            option.textContent = bin.BinCode;
            select.appendChild(option);
        });
        
        status.textContent = `${bins.length} bin locations available`;
        status.className = 'text-success';
        refreshBtn.style.display = '';
    } else {
        select.innerHTML = '<option value="">No bin locations found</option>';
        status.textContent = 'No bin locations available for this warehouse';
        status.className = 'text-warning';
    }
}

// Load bin locations when modal opens
document.getElementById('addItemModal').addEventListener('shown.bs.modal', function() {
    const fromWarehouse = document.getElementById('from_warehouse_code').value;
    const toWarehouse = document.getElementById('to_warehouse_code').value;
    
    // Load bin locations if warehouses are set
    if (fromWarehouse) {
        loadBinLocations(fromWarehouse, 'from');
    }
    if (toWarehouse) {
        loadBinLocations(toWarehouse, 'to');
    }
});

// Initialize feather icons after bin dropdowns are loaded
document.addEventListener('DOMContentLoaded', function() {
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
});
</script>

<script src="{{ url_for('static', filename='js/inventory_transfer_item_validation.js') }}"></script>
{% endblock %}
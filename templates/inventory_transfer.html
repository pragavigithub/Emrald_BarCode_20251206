{% extends "base.html" %}

{% block title %}Inventory Transfer - WMS{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1>Inventory Transfer</h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTransferModal">
                <i data-feather="plus"></i> Create Transfer
            </button>
        </div>
    </div>
</div>

<!-- Transfer Documents -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <!-- Date Filters and Search -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="fromDate" class="form-label small mb-1">From Date</label>
                        <input type="date" class="form-control form-control-sm" id="fromDate" name="from_date" 
                               value="{{ from_date or '' }}" onchange="applyFilters()">
                    </div>
                    <div class="col-md-3">
                        <label for="toDate" class="form-label small mb-1">To Date</label>
                        <input type="date" class="form-control form-control-sm" id="toDate" name="to_date" 
                               value="{{ to_date or '' }}" onchange="applyFilters()">
                    </div>
                    <div class="col-md-6">
                        <label for="searchInput" class="form-label small mb-1">Search</label>
                        <div class="d-flex">
                            <input id="searchInput" class="form-control form-control-sm"
                                   type="search" name="search" placeholder="Search deliveries..."
                                   aria-label="Search" value="{{ search_term or '' }}" 
                                   onkeypress="if(event.key === 'Enter') { event.preventDefault(); applyFilters(); }">
                            {% if search_term or from_date or to_date %}
                            <button class="btn btn-outline-secondary btn-sm ms-2" onclick="clearFilters()" type="button">
                                <i data-feather="x"></i> Clear
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0">Transfer Documents</h5>
                </div>
                <!-- Rows per page selector -->
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <label for="rowsPerPageTransfer" class="form-label mb-0 me-2">Rows per page:</label>
                        <select id="rowsPerPageTransfer" class="form-select form-select-sm" style="width: auto;"
                                onchange="changeRowsPerPageTransfer(this.value)">
                            <option value="5" {{
                            'selected' if per_page == 5 else '' }}>5</option>
                            <option value="10" {{
                            'selected' if per_page == 10 else '' }}>10</option>
                            <option value="25" {{
                            'selected' if per_page == 25 else '' }}>25</option>
                            <option value="50" {{
                            'selected' if per_page == 50 else '' }}>50</option>
                            <option value="100" {{
                            'selected' if per_page == 100 else '' }}>100</option>
                        </select>
                    </div>
                    {% if pagination %}
                    <small class="text-muted">
                        Showing {{ ((pagination.page - 1) * pagination.per_page + 1) }} to
                        {{ ((pagination.page - 1) * pagination.per_page + transfers|length) }}
                        of {{ pagination.total }} items
                    </small>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                {% if transfers %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th>Transfer ID</th>
                            <th>Request Number</th>
                            <th>Status</th>
                            <th>SAP Document</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for transfer in transfers %}
                        <tr>
                            <td>{{ transfer.id }}</td>
                            <td>{{ transfer.transfer_request_number }}</td>
                            <td>
                                {% if transfer.status == 'draft' %}
                                <span class="badge bg-warning">Draft</span>
                                {% elif transfer.status == 'approved' %}
                                <span class="badge bg-success">Approved</span>
                                {% elif transfer.status == 'rejected' %}
                                <span class="badge bg-danger">Rejected</span>
                                {% elif transfer.status == 'posted' %}
                                <span class="badge bg-success">Posted</span>
                                {% endif %}
                            </td>
                            <td>{{ transfer.sap_document_number or 'N/A' }}</td>
                            <td>{{ transfer.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>
                                <div class="btn-group" role="group">
                                    <a href="{{ url_for('inventory_transfer_detail', transfer_id=transfer.id) }}"
                                       class="btn btn-sm btn-outline-primary">
                                        <i data-feather="eye"></i> View
                                    </a>
                                    {% if transfer.status == 'draft' %}
                                    <a href="{{ url_for('edit_inventory_transfer', transfer_id=transfer.id) }}"
                                       class="btn btn-sm btn-outline-warning">
                                        <i data-feather="edit-2"></i> Edit
                                    </a>
                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                            onclick="confirmDeleteTransfer({{ transfer.id }}, '{{ transfer.transfer_request_number }}')">
                                        <i data-feather="trash-2"></i> Delete
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                {% if pagination and pagination.pages > 1 %}
                <nav aria-label="Transfer Documents pagination" class="mt-3">
                    <ul class="pagination pagination-sm justify-content-center">
                        <!-- Previous Page -->
                        {% if pagination.has_prev %}
                        <li class="page-item">
                            <a class="page-link"
                               href="{{ url_for('inventory_transfer', page=pagination.prev_num, search=search_term, per_page=per_page, from_date=from_date, to_date=to_date) }}">
                                <i data-feather="chevron-left"></i>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link"><i data-feather="chevron-left"></i></span>
                        </li>
                        {% endif %}

                        <!-- Page Numbers -->
                        {% for page_num in pagination.iter_pages() %}
                        {% if page_num %}
                        {% if page_num != pagination.page %}
                        <li class="page-item">
                            <a class="page-link"
                               href="{{ url_for('inventory_transfer', page=page_num, search=search_term, per_page=per_page, from_date=from_date, to_date=to_date) }}">{{
                                page_num }}</a>
                        </li>
                        {% else %}
                        <li class="page-item active">
                            <span class="page-link">{{ page_num }}</span>
                        </li>
                        {% endif %}
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                        {% endif %}
                        {% endfor %}

                        <!-- Next Page -->
                        {% if pagination.has_next %}
                        <li class="page-item">
                            <a class="page-link"
                               href="{{ url_for('inventory_transfer', page=pagination.next_num, search=search_term, per_page=per_page, from_date=from_date, to_date=to_date) }}">
                                <i data-feather="chevron-right"></i>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link"><i data-feather="chevron-right"></i></span>
                        </li>
                        {% endif %}
                    </ul>
                </nav>

                {% endif %}

                {% else %}
                <div class="text-center py-4">
                    <i data-feather="move" style="width: 48px; height: 48px;" class="text-muted mb-3"></i>
                    {% if search_term %}
                    <h5>No Results Found</h5>
                    <p class="text-muted">No transfer documents match your search criteria</p>
                    <button class="btn btn-outline-secondary" onclick="clearFilters()">Clear Filters</button>
                    {% else %}
                    <h5>No Transfer Documents</h5>
                    <p class="text-muted">Create your first inventory transfer to get started.</p>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Create Transfer Modal -->
<div class="modal fade" id="createTransferModal" tabindex="-1" aria-labelledby="createTransferModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createTransferModalLabel">Create Inventory Transfer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('create_inventory_transfer') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="invt_series" class="form-label">Document Series <span
                                class="text-danger">*</span></label>
                        <select class="form-select" id="invt_series" name="invt_series" required>
                            <option value="">Select Series</option>
                        </select>
                        <small class="form-text text-muted">Select the document series for the transfer request</small>
                    </div>

                    <div class="mb-3">
                        <label for="doc_num" class="form-label">Document Number <span
                                class="text-danger">*</span></label>
                        <div class="input-group">
                            <select class="form-select" id="doc_num" name="doc_num" required disabled>
                                <option value="">Select Series First</option>
                            </select>
                            <button class="btn btn-outline-secondary" type="button" onclick="scanDocNum()">
                                <i data-feather="camera"></i> Scan
                            </button>
                        </div>
                        <small class="form-text text-muted">Select the document series first</small>
                    </div>

                    <input type="hidden" id="transfer_request_number" name="transfer_request_number">
                    <input type="hidden" id="doc_entry" name="doc_entry">

                    <div class="scanner-container" id="transferScannerContainer" style="display: none;">
                        <video id="transferScanVideo" class="scanner-video" autoplay></video>
                        <div class="scanner-overlay"></div>
                    </div>

                    <div id="transferValidationResult" style="display: none;"></div>

<!--                    <div class="form-check mt-3">-->
<!--                        <input class="form-check-input" type="checkbox" id="auto_populate_items"-->
<!--                               name="auto_populate_items">-->
<!--                        <label class="form-check-label" for="auto_populate_items">-->
<!--                            Auto-populate items from SAP transfer request-->
<!--                        </label>-->
<!--                        <small class="form-text text-muted d-block">-->
<!--                            When checked, all open items from the SAP transfer request will be automatically added to-->
<!--                            the transfer.-->
<!--                        </small>-->
<!--                    </div>-->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Transfer</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteTransferModal" tabindex="-1" aria-labelledby="deleteTransferModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteTransferModalLabel">
                    <i data-feather="alert-triangle"></i> Confirm Delete
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this transfer document?</p>
                <p class="mb-0"><strong>Request Number:</strong> <span id="deleteRequestNumber"></span></p>
                <p class="text-muted small mt-2">This action cannot be undone. All associated items will also be deleted.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteTransferForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i data-feather="trash-2"></i> Delete Transfer
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function changeRowsPerPageTransfer(perPage) {
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('per_page', perPage);
        urlParams.delete('page');
        window.location.href = '{{ url_for("inventory_transfer") }}?' + urlParams.toString();
    }

    function applyFilters() {
        const fromDate = document.getElementById('fromDate').value;
        const toDate = document.getElementById('toDate').value;
        const search = document.getElementById('searchInput').value;
        const perPage = document.getElementById('rowsPerPageTransfer').value;

        const urlParams = new URLSearchParams();
        if (fromDate) urlParams.set('from_date', fromDate);
        if (toDate) urlParams.set('to_date', toDate);
        if (search) urlParams.set('search', search);
        if (perPage) urlParams.set('per_page', perPage);

        window.location.href = '{{ url_for("inventory_transfer") }}?' + urlParams.toString();
    }

    function clearFilters() {
        const perPage = document.getElementById('rowsPerPageTransfer').value;
        window.location.href = '{{ url_for("inventory_transfer") }}?per_page=' + perPage;
    }

    // Load INVT series when modal is opened
    document.getElementById('createTransferModal').addEventListener('shown.bs.modal', async function () {
        await loadInvtSeries();
    });

    async function loadInvtSeries() {
        try {
            const response = await fetch('/api/get-invt-series');
            const data = await response.json();

            const seriesSelect = document.getElementById('invt_series');
            seriesSelect.innerHTML = '<option value="">Select Series</option>';

            if (data.success && data.series) {
                data.series.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.Series;
                    option.textContent = `${item.SeriesName} (${item.Series})`;
                    seriesSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading INVT series:', error);
        }
    }

    // Load inventory transfer document numbers when series is selected
    async function loadInvtDocNumbers(series) {
        const docNumSelect = document.getElementById('doc_num');
        docNumSelect.innerHTML = '<option value="">Loading...</option>';
        docNumSelect.disabled = true;

        try {
            const response = await fetch(`/api/get-invt-docnums?series=${series}`);
            const data = await response.json();

            if (data.success && data.documents && data.documents.length > 0) {
                docNumSelect.innerHTML = '<option value="">Select Document Number</option>';
                data.documents.forEach(doc => {
                    const option = document.createElement('option');
                    option.value = doc.DocNum;
                    option.textContent = `${doc.DocNum} - ${doc.SeriesName || 'Series ' + doc.Series}`;
                    option.setAttribute('data-doc-entry', doc.DocEntry);
                    option.setAttribute('data-series', doc.Series);
                    docNumSelect.appendChild(option);
                });
                docNumSelect.disabled = false;
            } else {
                docNumSelect.innerHTML = '<option value="">No Open Documents Found</option>';
                docNumSelect.disabled = true;
            }
        } catch (error) {
            console.error('Error loading Inventory Transfer document numbers:', error);
            docNumSelect.innerHTML = '<option value="">Error Loading Documents</option>';
            docNumSelect.disabled = true;
        }
    }

    // When both series and doc_num are entered, fetch DocEntry
    async function fetchDocEntry() {
        const series = document.getElementById('invt_series').value;
        const docNum = document.getElementById('doc_num').value;

        if (!series || !docNum) {
            return;
        }

        try {
            const response = await fetch(`/api/get-invt-docentry?series=${series}&doc_num=${docNum}`);
            const data = await response.json();

            if (data.success && data.doc_entry) {
                document.getElementById('doc_entry').value = data.doc_entry;
                // Fetch document details to validate status
                await validateInvtDocument(data.doc_entry, docNum);
            } else {
                showValidationResult('danger', `No document found for Series ${series} and DocNum ${docNum}`);
                document.getElementById('doc_entry').value = '';
            }
        } catch (error) {
            console.error('Error fetching DocEntry:', error);
            showValidationResult('danger', 'Error fetching document details');
        }
    }

    async function validateInvtDocument(docEntry, docNum) {
        try {
            const response = await fetch(`/api/get-invt-details?doc_entry=${docEntry}`);
            const data = await response.json();

            if (data.success && data.data) {
                const invtData = data.data;
                const docStatus = invtData.DocumentStatus;

                // Check if document is open (bost_Open)
                if (docStatus !== 'bost_Open') {
                    showValidationResult('danger', `Document ${docNum} is closed and cannot be processed. Only open documents (bost_Open) are allowed.`);
                    document.getElementById('doc_entry').value = '';
                    return;
                }

                // Document is valid and open
                document.getElementById('transfer_request_number').value = docNum;

                showValidationResult('success', `
                    <strong>Valid Transfer Request:</strong> ${docNum} (DocEntry: ${docEntry})
                    <br><small>From: ${invtData.FromWarehouse || 'N/A'} â†’ To: ${invtData.ToWarehouse || 'N/A'}</small>
                    <br><small>Items: ${invtData.StockTransferLines ? invtData.StockTransferLines.length : 0}</small>
                    <br><small>Status: Open</small>
                `);
            } else {
                showValidationResult('danger', 'Could not validate document details');
            }
        } catch (error) {
            console.error('Error validating INVT document:', error);
            showValidationResult('danger', 'Error validating document');
        }
    }

    function showValidationResult(type, message) {
        const resultDiv = document.getElementById('transferValidationResult');
        resultDiv.innerHTML = `
            <div class="alert alert-${type}">
                ${message}
            </div>
        `;
        resultDiv.style.display = 'block';
    }

    // Event listeners for series and doc_num changes
    document.getElementById('invt_series').addEventListener('change', function() {
        const series = this.value;
        const docNumSelect = document.getElementById('doc_num');

        if (series) {
            loadInvtDocNumbers(series);
        } else {
            docNumSelect.innerHTML = '<option value="">Select Series First</option>';
            docNumSelect.disabled = true;
            document.getElementById('transferValidationResult').style.display = 'none';
        }
    });

    document.getElementById('doc_num').addEventListener('change', fetchDocEntry);

    function scanDocNum() {
        const container = document.getElementById('transferScannerContainer');
        const video = document.getElementById('transferScanVideo');

        container.style.display = 'block';

        startBarcodeScanner('transferScanVideo', function(code) {
            container.style.display = 'none';
            stopBarcodeScanner();

            // Try to find and select the scanned DocNum in the dropdown
            const docNumSelect = document.getElementById('doc_num');
            let found = false;

            for (let i = 0; i < docNumSelect.options.length; i++) {
                if (docNumSelect.options[i].value == code) {
                    docNumSelect.selectedIndex = i;
                    found = true;

                    // Trigger validation
                    fetchDocEntry();
                    break;
                }
            }

            if (!found && code) {
                const resultDiv = document.getElementById('transferValidationResult');
                resultDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Document ${code} not found in the current series.</strong>
                        <br>Please select the correct series first or verify the document number.
                    </div>
                `;
                resultDiv.style.display = 'block';
            }
        });
    }

    document.getElementById('searchInput').addEventListener('input', function () {
        clearTimeout(window._transferSearchTimeout);
        window._transferSearchTimeout = setTimeout(() => {
            applyFilters();
        }, 500);
    });

    // Clean up scanner when modal is closed
    document.getElementById('createTransferModal').addEventListener('hidden.bs.modal', function () {
        stopBarcodeScanner();
        document.getElementById('transferScannerContainer').style.display = 'none';
        document.getElementById('transferValidationResult').style.display = 'none';
        document.getElementById('invt_series').value = '';
        document.getElementById('doc_num').value = '';
        document.getElementById('transfer_request_number').value = '';
        document.getElementById('doc_entry').value = '';
    });

    // Delete transfer confirmation
    function confirmDeleteTransfer(transferId, requestNumber) {
        document.getElementById('deleteRequestNumber').textContent = requestNumber;
        document.getElementById('deleteTransferForm').action = '/delete_inventory_transfer/' + transferId;
        
        const modal = new bootstrap.Modal(document.getElementById('deleteTransferModal'));
        modal.show();
        
        // Re-initialize feather icons for modal
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
    }
</script>
{% endblock %}

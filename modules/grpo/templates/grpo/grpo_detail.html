{% extends "base.html" %}

{% block title %}GRPO Detail - {{ grpo_doc.po_number }}{% endblock %}

{% block extra_styles %}
<style>
@media print {
    .modal-header, .modal-footer, nav, .breadcrumb, .card-header .btn {
        display: none !important;
    }
    
    .modal-dialog {
        max-width: 100% !important;
        margin: 0 !important;
    }
    
    .modal-content {
        border: none !important;
        box-shadow: none !important;
    }
    
    .card {
        page-break-inside: avoid;
        border: 1px solid #000 !important;
        margin-bottom: 10px;
    }
    
    .col-md-4 {
        width: 33.333% !important;
        float: left;
    }
    
    body {
        background: white;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('grpo') }}">GRN</a></li>
                    <li class="breadcrumb-item active">{{ grpo_doc.po_number }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- GRPO Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i data-feather="package"></i>
                            Goods Received Note - {{ grpo_doc.po_number }}
                        </h5>
                        <div>
                            {% if grpo_doc.status == 'draft' %}
                                <span class="badge bg-secondary">Draft</span>
                            {% elif grpo_doc.status == 'approved' %}
                                <span class="badge bg-success">Approved</span>
                            {% elif grpo_doc.status == 'posted' %}
                                <span class="badge bg-primary">Posted</span>
                            {% elif grpo_doc.status == 'rejected' %}
                                <span class="badge bg-danger">Rejected</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>PO Number:</strong> {{ grpo_doc.po_number }}</p>
                            <p><strong>Supplier:</strong> {{ grpo_doc.supplier_name or 'Unknown' }} ({{ grpo_doc.supplier_code or 'N/A' }})</p>
                            <p><strong>SAP Document:</strong> {{ grpo_doc.sap_document_number or 'Not assigned' }}</p>
                            <p><strong>Status:</strong> {{ grpo_doc.status.title() }}</p>
                            <p><strong>Mode:</strong> {{ 'Draft Mode' if grpo_doc.draft_or_post == 'draft' else 'Direct Post' }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Created By:</strong> {{ grpo_doc.user.first_name }} {{ grpo_doc.user.last_name }}</p>
                            <p><strong>Created At:</strong> {{ grpo_doc.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                            <p><strong>Updated At:</strong> {{ grpo_doc.updated_at.strftime('%Y-%m-%d %H:%M') }}</p>
                            {% if grpo_doc.qc_user %}
                            <p><strong>QC Reviewer:</strong> {{ grpo_doc.qc_user.first_name }} {{ grpo_doc.qc_user.last_name }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Purchase Order Items -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i data-feather="list"></i>
                        Purchase Order Items
                    </h6>
                </div>
                <div class="card-body">
                    {% if po_items %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Item Code</th>
                                    <th>Description</th>
                                    <th>Ordered</th>
                                    <th>UoM</th>
                                    <th>Price</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for po_item in po_items %}
                                <tr>
                                    <td><strong>{{ po_item.get('ItemCode', '') }}</strong></td>
                                    <td>{{ po_item.get('ItemDescription') }}</td>
                                    <td>{{ po_item.get('Quantity', 0) }}</td>
                                    <td>{{ po_item.get('UoMCode', po_item.get('UoMEntry')) }}</td>
                                    <td>${{ "%.2f"|format(po_item.get('Price', 0)|float) }}</td>
                                    <td>
                                        {% if po_item.get('LineStatus') == 'bost_Open' %}
                                            <span class="badge bg-success">Open</span>
                                        {% elif po_item.get('LineStatus') == 'bost_Close' %}
                                            <span class="badge bg-secondary">Closed</span>
                                        {% else %}
                                            <span class="badge bg-warning">{{ po_item.get('LineStatus', 'Unknown') }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if po_item.get('LineStatus') == 'bost_Close' %}
                                            <!-- Disabled button for closed items -->
                                            <button class="btn btn-sm btn-secondary add-item-btn" disabled
                                                    title="Cannot add items from closed PO lines">
                                                <i data-feather="x"></i> Closed
                                            </button>
                                        {% else %}
                                            <!-- Enabled button for open items -->
                                            <button class="btn btn-sm btn-primary add-item-btn"
                                                    data-item-code="{{ po_item.get('ItemCode', '') }}"
                                                    data-item-name="{{ po_item.get('ItemDescription') }}"
                                                    data-uom="{{ po_item.get('UoMCode', po_item.get('UoMEntry')) }}"
                                                    data-warehouse="{{ po_item.get('WarehouseCode', 'WH001') }}"
                                                    data-po-item="{{ po_item|tojson|e }}"
                                                    data-ordered-qty="{{ po_item.get('Quantity') }}"
                                                    data-open-qty="{{ po_item.get('OpenQuantity', po_item.get('OpenQty')) }}"
                                                    data-line-status="{{ po_item.get('LineStatus') }}">
                                                <i data-feather="plus"></i> Add Item
                                            </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <i data-feather="alert-triangle"></i>
                        No purchase order items found. Make sure the PO number is correct and accessible.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Received Items -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i data-feather="check-square"></i>
                            Received Items
                        </h6>
                        {% if grpo_doc.status in ['draft', 'rejected'] %}
                        <button class="btn btn-success btn-sm" onclick="showAddItemModal()">
                            <i data-feather="plus"></i> Add Item
                        </button>
                        {% else %}
                        <button class="btn btn-secondary btn-sm" disabled title="Cannot add items to {{ grpo_doc.status }} GRPO">
                            <i data-feather="lock"></i> Add Item
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    {% if grpo_doc.items %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Item Code</th>
                                    <th>Description</th>
                                    <th>PO Qty</th>
                                    <th>Received Qty</th>
                                    <th>UoM</th>
                                    <th>Qty per Pack</th>
                                    <th>No of Packs</th>
                                    <th>Warehouse</th>
<!--                                    <th>Batch</th>-->
<!--                                    <th>Expiry</th>-->
                                    <th>QC Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in grpo_doc.items %}
                                <tr>
                                    <td><strong>{{ item.item_code }}</strong></td>
                                    <td>{{ item.item_name }}</td>
                                    <td>{{ item.po_quantity or '-' }}</td>
                                    <td>
                                        {% if grpo_doc.status in ['draft', 'rejected'] %}
                                        <input type="number" class="form-control form-control-sm"
                                               value="{{ item.received_quantity }}"
                                               min="0" step="0.01"
                                               data-item-id="{{ item.id }}"
                                               data-field="received_quantity"
                                               onchange="updateField(this)"
                                               style="width: 80px;">
                                        {% else %}
                                        <strong>{{ item.received_quantity }}</strong>
                                        {% endif %}
                                    </td>
                                    <td><strong>{{ item.unit_of_measure or 'EA' }}</strong></td>
                                    <td>
                                        {% if item.serial_numbers and item.serial_numbers|length > 0 %}
                                            {{ item.serial_numbers[0].qty_per_pack or '-' }}
                                        {% elif item.batch_numbers and item.batch_numbers|length > 0 %}
                                            {{ item.batch_numbers[0].qty_per_pack or '-' }}
                                        {% elif item.non_managed_items and item.non_managed_items|length > 0 %}
                                            {{ item.non_managed_items[0].qty_per_pack or '-' }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.serial_numbers and item.serial_numbers|length > 0 %}
                                            {{ item.serial_numbers[0].no_of_packs or '-' }}
                                        {% elif item.batch_numbers and item.batch_numbers|length > 0 %}
                                            {{ item.batch_numbers[0].no_of_packs or '-' }}
                                        {% elif item.non_managed_items and item.non_managed_items|length > 0 %}
                                            {{ item.non_managed_items[0].no_of_packs or '-' }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set warehouse_code = item.bin_location.split('-')[0] if item.bin_location and '-' in item.bin_location else item.bin_location[:4] if item.bin_location else 'N/A' %}
                                        <strong>{{ warehouse_code }}</strong>
                                        <br><small class="text-muted">{{ item.bin_location }}</small>
                                    </td>
<!--                                    <td>-->
<!--                                        {% if grpo_doc.status in ['draft', 'rejected'] %}-->
<!--                                        <input type="text" class="form-control form-control-sm"-->
<!--                                               value="{{ item.batch_number or '' }}"-->
<!--                                               placeholder="Batch number"-->
<!--                                               data-item-id="{{ item.id }}"-->
<!--                                               data-field="batch_number"-->
<!--                                               onchange="updateField(this)"-->
<!--                                               style="width: 120px;">-->
<!--                                        {% else %}-->
<!--                                        {{ item.batch_number or '-' }}-->
<!--                                        {% endif %}-->
<!--                                    </td>-->
<!--                                    <td>-->
<!--                                        {% if grpo_doc.status in ['draft', 'rejected'] %}-->
<!--                                        <input type="date" class="form-control form-control-sm"-->
<!--                                               value="{{ item.expiration_date.strftime('%Y-%m-%d') if item.expiration_date else '' }}"-->
<!--                                               data-item-id="{{ item.id }}"-->
<!--                                               data-field="expiration_date"-->
<!--                                               onchange="updateField(this)"-->
<!--                                               style="width: 140px;">-->
<!--                                        {% else %}-->
<!--                                        {{ item.expiration_date.strftime('%Y-%m-%d') if item.expiration_date else '-' }}-->
<!--                                        {% endif %}-->
<!--                                    </td>-->

                                    <td>
                                        {% if item.qc_status == 'pending' %}
                                            <span class="badge bg-warning">Pending</span>
                                        {% elif item.qc_status == 'approved' %}
                                            <span class="badge bg-success">Approved</span>
                                        {% elif item.qc_status == 'rejected' %}
                                            <span class="badge bg-danger">Rejected</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.serial_numbers %}
                                        <button class="btn btn-sm btn-primary" onclick="generateSerialQRLabels({{ item.id }}, '{{ item.item_code }}', '{{ item.item_name }}')">
                                            <i data-feather="printer"></i> Print {{ item.serial_numbers|length }} QR Labels
                                        </button>
                                        {% elif item.batch_numbers %}
                                        <button class="btn btn-sm btn-info" onclick="generateBatchQRLabels({{ item.id }}, '{{ item.item_code }}', '{{ item.item_name }}')">
                                            <i data-feather="printer"></i> Print Batch Labels
                                        </button>
                                        {% elif item.non_managed_items %}
                                        <button class="btn btn-sm btn-warning" onclick="generateNonManagedQRLabels({{ item.id }}, '{{ item.item_code }}', '{{ item.item_name }}')">
                                            <i data-feather="printer"></i> Print {{ item.non_managed_items|length }} QR Labels
                                        </button>
                                        {% else %}
                                        <button class="btn btn-sm btn-success" onclick="generateQRLabel('{{ item.item_code }}', '{{ item.item_name }}', '{{ item.batch_number or '' }}', {{ grpo_doc.id }}, '{{ grpo_doc.po_number }}')">
                                            <i data-feather="maximize"></i> QR Label
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i data-feather="info"></i>
                        No items have been received yet. Add items from the purchase order above.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('grpo') }}" class="btn btn-secondary">
                            <i data-feather="arrow-left"></i> Back to GRPO List
                        </a>
                        <div>
                            {% if grpo_doc.status == 'draft' %}
                            <button id="submitQCBtn" class="btn btn-success" onclick="submitGRPO({{ grpo_doc.id }})" {% if not grpo_doc.items %}disabled{% endif %}>
                                <i data-feather="check"></i> Submit for QC Approval
                            </button>
                            {% if not grpo_doc.items %}
                            <small class="text-muted d-block">Add items to enable submission</small>
                            {% endif %}
                            {% elif grpo_doc.status == 'submitted' and current_user.role in ['qc', 'manager', 'admin'] %}
                            <div class="btn-group">
                                <button class="btn btn-success" onclick="approveGRPO({{ grpo_doc.id }})">
                                    <i data-feather="check"></i> Approve & Post to SAP
                                </button>
                                <button class="btn btn-danger" onclick="rejectGRPO({{ grpo_doc.id }})">
                                    <i data-feather="x"></i> Reject
                                </button>
                            </div>
                            {% elif grpo_doc.status == 'approved' and current_user.role in ['admin', 'manager'] %}
                            <div class="btn-group">
                                <form method="POST" action="{{ url_for('post_grpo_to_sap_manual', grpo_id=grpo_doc.id) }}" style="display: inline;">
                                    <button type="submit" class="btn btn-primary" id="postToSAPBtn" onclick="return postToSAPConfirm(this)">
                                        <i data-feather="upload"></i> Post to SAP B1
                                    </button>
                                </form>
                                <button type="button" class="btn btn-info" onclick="showJsonPreview({{ grpo_doc.id }})">
                                    <i data-feather="eye"></i> Preview JSON
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Item to GRN</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addItemForm" method="POST" action="{{ url_for('add_grpo_item', grpo_id=grpo_doc.id) }}" onsubmit="return prepareSerialDataForSubmit()">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="item_code" class="form-label">Item Code <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="item_code" name="item_code"
                               onchange="handleItemCodeChange()" required>
                    </div>
                    <div class="mb-3">
                        <label for="item_name" class="form-label">Item Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="item_name" name="item_name" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="quantity" class="form-label">Quantity <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="quantity" name="quantity" step="0.01" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="unit_of_measure" class="form-label">Unit of Measure (UoM) <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="unit_of_measure" name="unit_of_measure" value="EA" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Warehouse and Bin Location -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="warehouse_code" class="form-label">Warehouse <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="warehouse_code" name="warehouse_code"
                                       placeholder="Warehouse from PO" readonly required>
                                <small class="form-text text-muted">Warehouse code from Purchase Order</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="bin_location" class="form-label">Bin Location</label>
                                <div class="input-group">
                                    <select class="form-select" id="bin_select" onchange="handleBinSelection()">
                                        <option value="">Select Bin Location...</option>
                                    </select>
                                    <button class="btn btn-outline-secondary" type="button" onclick="toggleManualBin()" title="Enter manually">
                                        <i data-feather="edit-3"></i>
                                    </button>
                                </div>
                                <input type="text" class="form-control mt-2" id="bin_location" name="bin_location"
                                       placeholder="Or enter bin location manually" style="display: none;">
                            </div>
                        </div>
                    </div>

                    <!-- Serial/Batch Management Section -->
                    <!-- Standard Item Section (Hidden by default, shown for non-batch/non-serial items) -->
                    <div id="standard_item_section" style="display: none;">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="standard_expiration_date" class="form-label">Expiration Date (Optional)</label>
                                    <input type="date" class="form-control" id="standard_expiration_date" name="standard_expiration_date">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="standard_number_of_bags" class="form-label">Number of Bag</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="standard_number_of_bags" name="number_of_bags_NSB"
                                               placeholder="Enter number of bags for label printing" min="1" max="1000" step="1">
                                        <button class="btn btn-success" type="button" onclick="generateStandardBarcodeLabels()" title="Generate barcode labels for bags">
                                            <i data-feather="printer"></i> Generate Labels
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">Enter the number of bags to generate QR labels with PO, GRN date, expiry, item details (e.g., 5 will generate labels 1 of 5, 2 of 5, etc.)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Batch Section (Hidden by default, shown for batch managed items) -->
                    <div id="batch_section" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="batch_number" class="form-label">Batch Number</label>
                                    <div class="input-group">
                                        <select class="form-select" id="batch_select" onchange="handleBatchSelection()" disabled>
                                            <option value="">Select Batch...</option>
                                        </select>
                                        <button class="btn btn-outline-secondary" type="button" onclick="toggleManualBatch()" title="Enter manually">
                                            <i data-feather="edit-3"></i>
                                        </button>
                                    </div>
                                    <div class="input-group mt-2" id="batch_number_manual_group" style="display: none;">
                                        <input type="text" class="form-control" id="batch_number" name="batch_number"
                                               placeholder="Or enter batch number manually">
                                        <button class="btn btn-outline-primary" type="button" onclick="generateBatchBarcode()" title="Generate barcode for batch">
                                            <i data-feather="maximize-2"></i> Generate Barcode
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="expiration_date" class="form-label">Expiration Date</label>
                                    <input type="date" class="form-control" id="expiration_date" name="expiration_date">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="number_of_bags" class="form-label">Number of Bags</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="number_of_bags" name="number_of_bags_Batch"
                                               placeholder="Enter number of bags for label printing" min="1" max="1000" step="1">
                                        <button class="btn btn-success" type="button" onclick="generateBarcodeLabels()" title="Generate barcode labels for bags">
                                            <i data-feather="printer"></i> Generate Labels
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">Enter the number of bags to generate barcode labels (e.g., 10 will generate labels 1 of 10, 2 of 10, etc.)</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Serial Number Section (Hidden by default, shown for serial managed items) -->
                    <div id="serial_section" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">
                                <i data-feather="hash"></i> Serial Numbers 
                                <span class="badge bg-info">Required for Serial Managed Items</span>
                            </label>
                            <div id="serial_numbers_container" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                <!-- Serial number inputs will be dynamically generated here -->
                            </div>
                            <input type="hidden" id="serial_numbers_json" name="serial_numbers_json">
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="serial_number_of_bags" class="form-label">Number of Bags </label>
                                    <input type="number" class="form-control" id="serial_number_of_bags" name="number_of_bags_serials"
                                           placeholder="Enter number of bags for label printing" min="1" max="1000" step="1">
                                    <small class="form-text text-muted">Enter the number of bags to generate barcode labels (e.g., if you have 100 serials and enter 5, each bag will contain 20 serials)</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden field for batch numbers JSON -->
                    <input type="hidden" id="batch_numbers_json" name="batch_numbers_json">
                    
                    <!-- Hidden field for GRN date (for label generation) -->
                    <input type="hidden" id="grn_date" value="{{ grpo_doc.created_at.strftime('%Y-%m-%d') }}">

<!--                    <div class="mb-3">-->
<!--                        <label for="barcode" class="form-label">Supplier Barcode</label>-->
<!--                        <input type="text" class="form-control" id="barcode" name="barcode" placeholder="Scan or enter supplier barcode">-->
<!--                    </div>-->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Item</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Barcode Labels Modal -->
<div class="modal fade" id="barcodeLabelsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Batch Item Barcode Labels</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="barcodeLabelsContent">
                <!-- Labels will be generated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="window.print()">
                    <i data-feather="printer"></i> Print Labels
                </button>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script>
// Global variables - prevent duplicate declarations
if (typeof selectedPoItemData === 'undefined') {
    var selectedPoItemData = null;
}

// Handle batch selection
function handleBatchSelection() {
    const batchSelect = document.getElementById('batch_select');
    const batchNumber = document.getElementById('batch_number');
    const batchNumberGroup = document.getElementById('batch_number_manual_group');
    const expirationDate = document.getElementById('expiration_date');

    if (batchSelect.value) {
        batchNumber.value = batchSelect.value;
        batchNumberGroup.style.display = 'none';
        batchSelect.parentElement.style.display = 'flex';

        // Auto-fill expiration date from selected option
        const selectedOption = batchSelect.options[batchSelect.selectedIndex];
        const expiry = selectedOption.getAttribute('data-expiry');
        if (expiry) {
            expirationDate.value = expiry;
        }
    }
}
// Update field function
function updateField(element) {
    const itemId = element.getAttribute('data-item-id');
    const fieldName = element.getAttribute('data-field');
    const value = element.value;

    fetch('/grpo/item/' + itemId + '/update_field', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            field_name: fieldName,
            value: value
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Field updated successfully');
        } else {
            alert('Error updating field: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error updating field');
    });
}

// Toggle manual batch entry
function toggleManualBatch() {
    const batchSelect = document.getElementById('batch_select');
    const batchNumberGroup = document.getElementById('batch_number_manual_group');
    const batchNumber = document.getElementById('batch_number');

    if (batchNumberGroup.style.display === 'none') {
        batchNumberGroup.style.display = 'flex';
        batchSelect.parentElement.style.display = 'none';
        batchNumber.focus();
    } else {
        batchNumberGroup.style.display = 'none';
        batchSelect.parentElement.style.display = 'flex';
        batchSelect.focus();
    }
}

// Generate barcode for batch number
function generateBatchBarcode() {
    const batchNumber = document.getElementById('batch_number').value;
    const itemCode = document.getElementById('item_code').value;
    
    if (!batchNumber) {
        alert('Please enter a batch number first');
        return;
    }
    
    if (!itemCode) {
        alert('Item code is required to generate barcode');
        return;
    }
    
    // Generate barcode data for batch
    const barcodeData = `BATCH:${itemCode}-${batchNumber}`;
    
    // Create a modal to show the barcode (you can enhance this with actual QR code generation)
    const barcodeModal = `
        <div class="modal fade" id="batchBarcodeModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Batch Number Barcode</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <h6>Batch: ${batchNumber}</h6>
                        <h6>Item: ${itemCode}</h6>
                        <div id="batch-qrcode" class="my-3"></div>
                        <p class="text-muted">Barcode Data: ${barcodeData}</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="printBatchBarcode()">Print</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('batchBarcodeModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', barcodeModal);
    
    // Generate QR code
    const modal = new bootstrap.Modal(document.getElementById('batchBarcodeModal'));
    modal.show();
    
    // Generate QR code after modal is shown
    document.getElementById('batchBarcodeModal').addEventListener('shown.bs.modal', function() {
        const qrcodeContainer = document.getElementById('batch-qrcode');
        qrcodeContainer.innerHTML = ''; // Clear previous QR code
        new QRCode(qrcodeContainer, {
            text: barcodeData,
            width: 200,
            height: 200
        });
    });
    
    console.log(`Generated barcode for batch: ${batchNumber}, Data: ${barcodeData}`);
}

// Print batch barcode
function printBatchBarcode() {
    const qrcode = document.getElementById('batch-qrcode').innerHTML;
    const batchNumber = document.getElementById('batch_number').value;
    const itemCode = document.getElementById('item_code').value;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>Batch Barcode - ${batchNumber}</title>
            <style>
                body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
                h3 { margin: 10px 0; }
            </style>
        </head>
        <body>
            <h3>Batch Number: ${batchNumber}</h3>
            <h4>Item Code: ${itemCode}</h4>
            <div>${qrcode}</div>
            <script>
                window.onload = function() { window.print(); window.close(); }
            <\/script>
        </body>
        </html>
    `);
    printWindow.document.close();
}

// Generate multiple barcode labels for bags
function generateBarcodeLabels() {
    const batchNumber = document.getElementById('batch_number').value || document.getElementById('batch_select').value;
    const expirationDate = document.getElementById('expiration_date').value;
    const numberOfBags = parseInt(document.getElementById('number_of_bags').value);
    const itemCode = document.getElementById('item_code').value;
    const itemName = document.getElementById('item_name').value;
    const grnDate = document.getElementById('grn_date').value;
    
    if (!batchNumber) {
        alert('Please enter or select a batch number first');
        return;
    }
    
    if (!expirationDate) {
        alert('Please enter an expiration date');
        return;
    }
    
    if (!numberOfBags || numberOfBags < 1) {
        alert('Please enter a valid number of bags (minimum 1)');
        return;
    }
    
    if (numberOfBags > 1000) {
        alert('Maximum 1000 labels can be generated at once');
        return;
    }
    
    if (!grnDate) {
        alert('GRN date not available. Please refresh the page.');
        return;
    }
    
    let labelsHTML = '<div class="row g-3">';
    
    for (let i = 1; i <= numberOfBags; i++) {
        const qrcodeId = `qrcode_${i}`;
        const sequenceText = `${i} of ${numberOfBags}`;
        const barcodeData = `${itemCode}-${batchNumber}-${i}`;
        
        labelsHTML += `
            <div class="col-md-4 col-sm-6">
                <div class="card border">
                    <div class="card-body text-center p-3">
                        <h6 class="mb-2"><strong>${itemCode}</strong></h6>
                        <p class="mb-1 small">${itemName}</p>
                        <div id="${qrcodeId}" class="mb-2 d-flex justify-content-center"></div>
                        <p class="small mb-1"><strong>${barcodeData}</strong></p>
                        <div class="small">
                            <strong>Batch:</strong> ${batchNumber}<br>
                            <strong>GRN Date:</strong> ${grnDate}<br>
                            <strong>Exp Date:</strong> ${expirationDate}<br>
                            <strong>Bag:</strong> ${sequenceText}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    labelsHTML += '</div>';
    
    document.getElementById('barcodeLabelsContent').innerHTML = labelsHTML;
    
    const modal = new bootstrap.Modal(document.getElementById('barcodeLabelsModal'));
    modal.show();
    
    document.getElementById('barcodeLabelsModal').addEventListener('shown.bs.modal', function() {
        for (let i = 1; i <= numberOfBags; i++) {
            const qrcodeId = `qrcode_${i}`;
            const barcodeData = `${itemCode}-${batchNumber}-${i}`;
            
            try {
                new QRCode(document.getElementById(qrcodeId), {
                    text: barcodeData,
                    width: 128,
                    height: 128,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            } catch (error) {
                console.error(`Error generating QR code ${i}:`, error);
            }
        }
        
        feather.replace();
    }, { once: true });
    
    console.log(`Generated ${numberOfBags} QR code labels for batch: ${batchNumber}`);
}

// Handle warehouse selection
function handleWarehouseSelection() {
    const warehouseSelect = document.getElementById('warehouse_select');
    const warehouseCode = document.getElementById('warehouse_code');
    const binSelect = document.getElementById('bin_select');
    const batchSelect = document.getElementById('batch_select');

    if (warehouseSelect.value) {
        warehouseCode.value = warehouseSelect.value;
        warehouseCode.style.display = 'none';
        warehouseSelect.parentElement.style.display = 'flex';

        // Enable bin select and load bins
        binSelect.disabled = false;
        batchSelect.disabled = false;
        loadCascadingBinLocations(warehouseSelect.value);
        loadCascadingBatches();
    } else {
        binSelect.disabled = true;
        batchSelect.disabled = true;
        binSelect.innerHTML = '<option value="">Select Bin Location...</option>';
        batchSelect.innerHTML = '<option value="">Select Batch...</option>';
    }
}


// Add item to GRPO function
function addItemToGRPO(itemCode, itemName, uom, warehouseCode, poItemData) {
    selectedPoItemData = {
        itemCode: itemCode,
        itemName: itemName || 'N/A',
        uom: uom || 'N/A',
        warehouseCode: warehouseCode || 'N/A'
    };

    document.getElementById('item_code').value = itemCode;
    document.getElementById('item_name').value = selectedPoItemData.itemName;
    document.getElementById('unit_of_measure').value = selectedPoItemData.uom;
    document.getElementById('warehouse_code').value = selectedPoItemData.warehouseCode;

    // Hide batch/serial sections initially
    hideBatchSerialSections();

    // Load bin locations from SAP based on warehouse code
    if (warehouseCode) {
        loadCascadingBinLocations(warehouseCode);
    }

    // Validate item code to show appropriate batch/serial fields
    if (itemCode) {
        validateItemCodeFromSAP(itemCode);
    }

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('addItemModal'));
    modal.show();
}

// Load cascading warehouses
function loadCascadingWarehouses() {
    fetch('/api/warehouses')
        .then(response => response.json())
        .then(data => {
            const warehouseSelect = document.getElementById('warehouse_select');
            warehouseSelect.innerHTML = '<option value="">Select Warehouse...</option>';

            if (data.success && data.warehouses) {
                data.warehouses.forEach(warehouse => {
                    const option = document.createElement('option');
                    option.value = warehouse.WarehouseCode;
                    option.textContent = warehouse.WarehouseName || warehouse.WarehouseCode;
                    warehouseSelect.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error loading warehouses:', error);
        });
}

// Load cascading bin locations
function loadCascadingBinLocations(warehouseCode) {
    if (!warehouseCode) return;

    const binSelect = document.getElementById('bin_select');
    binSelect.innerHTML = '<option value="">Loading bin locations...</option>';
    binSelect.disabled = true;

    fetch(`/api/get-bins?warehouse=${warehouseCode}`)
        .then(response => response.json())
        .then(data => {
            binSelect.innerHTML = '<option value="">Select Bin Location...</option>';

            if (data.success && data.bins) {
                data.bins.forEach(bin => {
                    const option = document.createElement('option');
                    option.value = bin.BinCode;
                    option.textContent = bin.BinCode;
                    binSelect.appendChild(option);
                });
                binSelect.disabled = false;
                console.log(`âœ… Loaded ${data.bins.length} bin locations for warehouse ${warehouseCode}`);
            } else {
                binSelect.innerHTML = '<option value="">No bins available</option>';
                console.warn('No bin locations found for warehouse:', warehouseCode);
            }
        })
        .catch(error => {
            console.error('Error loading bin locations:', error);
            binSelect.innerHTML = '<option value="">Error loading bins</option>';
        });
}

// Load cascading batches
function loadCascadingBatches() {
    const itemCode = document.getElementById('item_code').value;
    const warehouseCode = document.getElementById('warehouse_code').value || document.getElementById('warehouse_select').value;

    if (!itemCode) {
        console.log('No item code available for batch loading');
        return;
    }

    console.log(`Loading batches for item: ${itemCode}, warehouse: ${warehouseCode}`);

    let url = `/api/get-batches?item=${itemCode}`;
    if (warehouseCode) {
        url += `&warehouse=${warehouseCode}`;
    } else {
        // If no warehouse is selected, try to use a default one
        url += `&warehouse=WH001`;
    }

    fetch(url)
        .then(response => response.json())
        .then(data => {
            console.log('Batch API response:', data);
            const batchSelect = document.getElementById('batch_select');
            batchSelect.innerHTML = '<option value="">Select Batch...</option>';

            if (data.success && data.batches && data.batches.length > 0) {
                data.batches.forEach(batch => {
                    const option = document.createElement('option');
                    option.value = batch.Batch || batch.BatchNumber;
                    option.textContent = `${batch.Batch || batch.BatchNumber} (Qty: ${batch.Quantity || 0}, Exp: ${batch.ExpirationDate || batch.ExpiryDate || 'N/A'})`;
                    option.setAttribute('data-expiry', batch.ExpirationDate || batch.ExpiryDate);
                    batchSelect.appendChild(option);
                });
                console.log(`Loaded ${data.batches.length} batches for item ${itemCode}`);
            } else {
                console.log('No batches found for item:', itemCode);
                // Add a message option to indicate no batches available
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No batches available';
                option.disabled = true;
                batchSelect.appendChild(option);
            }
            batchSelect.disabled = false;
        })
        .catch(error => {
            console.error('Error loading batches:', error);
            const batchSelect = document.getElementById('batch_select');
            batchSelect.disabled = false;
        });
}

// Global variable to store item validation result
let itemValidationResult = null;

// Handle item code change for cascading and validation
function handleItemCodeChange() {
    const itemCode = document.getElementById('item_code').value;
    if (itemCode) {
        // Enable SAP validation to check if item is batch/serial managed
        validateItemCodeFromSAP(itemCode);
        
        loadCascadingWarehouses();
        console.log(`Item ${itemCode} entered - validating item management type from SAP`);
    } else {
        // Clear dependent dropdowns when item code is cleared
        document.getElementById('batch_select').innerHTML = '<option value="">Select Batch...</option>';
        document.getElementById('batch_select').disabled = true;
        // Reset batch/serial sections
        hideBatchSerialSections();
    }
}

// Validate item code from SAP and show/hide appropriate fields
function validateItemCodeFromSAP(itemCode) {
    console.log(`ðŸ” Starting validation for item: ${itemCode}`);
    
    fetch(`/grpo/validate-item/${itemCode}`)
        .then(response => {
            console.log(`ðŸ“¡ Received response status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            itemValidationResult = data;
            console.log('ðŸ“¦ Full validation result:', JSON.stringify(data, null, 2));
            console.log('batch_required:', data.batch_required, 'typeof:', typeof data.batch_required);
            console.log('serial_required:', data.serial_required, 'typeof:', typeof data.serial_required);
            console.log('success:', data.success);
            
            // Show/hide fields based on validation
            // Get the batch, serial, and standard sections
            const batchSection = document.getElementById('batch_section');
            const serialSection = document.getElementById('serial_section');
            const standardSection = document.getElementById('standard_item_section');
            
            console.log('ðŸŽ¯ Batch section element:', batchSection);
            console.log('ðŸŽ¯ Serial section element:', serialSection);
            console.log('ðŸŽ¯ Standard section element:', standardSection);
            
            // Explicit boolean check - only show batch if batch_required is explicitly true
            if (data.batch_required === true) {
                // Show batch fields, hide serial and standard sections
                if (batchSection) {
                    batchSection.style.display = 'block';
                    console.log('âœ… Batch section shown (display: block)');
                }
                if (serialSection) {
                    serialSection.style.display = 'none';
                    console.log('âŒ Serial section hidden (display: none)');
                }
                if (standardSection) {
                    standardSection.style.display = 'none';
                    console.log('âŒ Standard section hidden (display: none)');
                }
                
                // Enable batch selection and load batches
                document.getElementById('batch_select').disabled = false;
                loadCascadingBatches();
                
                console.log(`âœ… Item ${itemCode} is BATCH managed - showing batch fields, hiding serial/standard fields`);
            } else if (data.serial_required === true) {
                // Show serial section, hide batch and standard sections
                if (batchSection) {
                    batchSection.style.display = 'none';
                    console.log('âŒ Batch section hidden (display: none)');
                }
                if (serialSection) {
                    serialSection.style.display = 'block';
                    console.log('âœ… Serial section shown (display: block)');
                    // Initialize serial number inputs based on quantity
                    initializeSerialInputs();
                }
                if (standardSection) {
                    standardSection.style.display = 'none';
                    console.log('âŒ Standard section hidden (display: none)');
                }
                
                console.log(`âœ… Item ${itemCode} is SERIAL managed - showing serial fields, hiding batch/standard fields`);
            } else {
                // Neither batch nor serial - show standard section, hide batch and serial
                if (batchSection) {
                    batchSection.style.display = 'none';
                    console.log('âŒ Batch section hidden (display: none)');
                }
                if (serialSection) {
                    serialSection.style.display = 'none';
                    console.log('âŒ Serial section hidden (display: none)');
                }
                if (standardSection) {
                    standardSection.style.display = 'block';
                    console.log('âœ… Standard section shown (display: block)');
                }
                
                console.log(`â„¹ï¸ Item ${itemCode} is standard item - showing expiry field`);
            }
        })
        .catch(error => {
            console.error('âŒ Error validating item code from SAP:', error);
            
            // Explicitly hide both batch and serial sections when validation fails
            hideBatchSerialSections();
            
            console.warn(`âš ï¸ SAP validation unavailable for ${itemCode} - unable to determine item management type`);
            
            // Show user-visible warning
            alert(`âš ï¸ Unable to validate item from SAP. Please verify the item code is correct.\n\nBatch/Serial fields will only appear after successful validation.`);
        });
}

// Hide all batch/serial/standard sections
function hideBatchSerialSections() {
    const batchSection = document.getElementById('batch_section');
    const serialSection = document.getElementById('serial_section');
    const standardSection = document.getElementById('standard_item_section');
    
    if (batchSection) batchSection.style.display = 'none';
    if (serialSection) serialSection.style.display = 'none';
    if (standardSection) standardSection.style.display = 'none';
}

// Initialize serial number inputs based on quantity
function initializeSerialInputs() {
    const quantity = parseInt(document.getElementById('quantity').value) || 0;
    const serialContainer = document.getElementById('serial_numbers_container');
    
    if (!serialContainer) return;
    
    // Clear existing inputs
    serialContainer.innerHTML = '';
    
    if (quantity > 0 && quantity <= 100) { // Limit to 100 serials for UI performance
        for (let i = 0; i < quantity; i++) {
            const serialDiv = document.createElement('div');
            serialDiv.className = 'mb-3 p-2 border rounded';
            serialDiv.innerHTML = `
                <div class="row g-2">
                    <div class="col-md-8">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">#${i + 1}</span>
                            <input type="text" class="form-control serial-input" 
                                   placeholder="Enter serial number ${i + 1}" 
                                   data-serial-index="${i}"
                                   required>
                            <button class="btn btn-outline-secondary" type="button" 
                                    onclick="generateSerialBarcode(${i})" 
                                    title="Generate barcode">
                                <i data-feather="maximize-2"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <input type="date" class="form-control form-control-sm serial-expiry-input" 
                               placeholder="Expiry date" 
                               data-expiry-index="${i}"
                               title="Expiry date (optional)">
                    </div>
                </div>
            `;
            serialContainer.appendChild(serialDiv);
        }
        
        // Reinitialize feather icons
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
        
        console.log(`Generated ${quantity} serial number inputs`);
    } else if (quantity > 100) {
        serialContainer.innerHTML = '<div class="alert alert-warning">Quantity too large for individual serial entry. Please use bulk upload.</div>';
    }
}

// Generate barcode for specific serial number
function generateSerialBarcode(index) {
    const serialInput = document.querySelector(`input[data-serial-index="${index}"]`);
    if (!serialInput || !serialInput.value) {
        alert('Please enter a serial number first');
        return;
    }
    
    const itemCode = document.getElementById('item_code').value;
    const serialNumber = serialInput.value;
    
    // Generate barcode data
    const barcodeData = `SN:${itemCode}-${serialNumber}`;
    
    // Show barcode preview (you can enhance this with QR code generation)
    alert(`Barcode generated for Serial: ${serialNumber}\nData: ${barcodeData}`);
    console.log(`Generated barcode for serial ${index}: ${barcodeData}`);
}

// Update quantity field listener to reinitialize serial inputs
document.addEventListener('DOMContentLoaded', function() {
    const quantityInput = document.getElementById('quantity');
    if (quantityInput) {
        quantityInput.addEventListener('change', function() {
            if (itemValidationResult && itemValidationResult.serial_required) {
                initializeSerialInputs();
            }
        });
    }
});

// Prepare serial data for form submission
function prepareSerialDataForSubmit() {
    // Handle batch managed items
    if (itemValidationResult && itemValidationResult.batch_required) {
        const batchNumber = document.getElementById('batch_number').value.trim();
        const expirationDate = document.getElementById('expiration_date').value;
        const quantity = parseFloat(document.getElementById('quantity').value) || 0;
        
        if (!batchNumber) {
            alert('Batch number is required for batch-managed items');
            document.getElementById('batch_number').focus();
            return false;
        }
        
        // Prepare batch numbers array with single batch
        const batchNumbers = [{
            batch_number: batchNumber,
            quantity: quantity,
            expiry_date: expirationDate || null,
            manufacturer_serial_number: '',
            internal_serial_number: ''
        }];
        
        // Store batch numbers as JSON in hidden field
        document.getElementById('batch_numbers_json').value = JSON.stringify(batchNumbers);
        console.log('Batch numbers prepared for submission:', batchNumbers);
    }
    
    // Handle serial managed items
    if (itemValidationResult && itemValidationResult.serial_required) {
        const serialInputs = document.querySelectorAll('.serial-input');
        const expiryInputs = document.querySelectorAll('.serial-expiry-input');
        const serialNumbers = [];
        
        for (let i = 0; i < serialInputs.length; i++) {
            const input = serialInputs[i];
            if (!input.value.trim()) {
                alert(`Please enter serial number #${parseInt(input.getAttribute('data-serial-index')) + 1}`);
                input.focus();
                return false; // Prevent form submission
            }
            
            const expiryInput = expiryInputs[i];
            const expiryDate = expiryInput && expiryInput.value ? expiryInput.value : null;
            
            serialNumbers.push({
                internal_serial_number: input.value.trim(),
                manufacturer_serial_number: input.value.trim(),
                expiry_date: expiryDate,
                manufacture_date: null,
                notes: ''
            });
        }
        
        // Store serial numbers as JSON in hidden field
        document.getElementById('serial_numbers_json').value = JSON.stringify(serialNumbers);
        console.log('Serial numbers prepared for submission:', serialNumbers);
    }
    
    return true; // Allow form submission
}

// Show add item modal
function showAddItemModal() {
    selectedPoItemData = null;

    // Clear form fields
    document.getElementById('item_code').value = '';
    document.getElementById('item_name').value = '';
    document.getElementById('unit_of_measure').value = 'EA';
    document.getElementById('warehouse_code').value = '';
    document.getElementById('quantity').value = '';
    document.getElementById('batch_number').value = '';
    document.getElementById('expiration_date').value = '';
    document.getElementById('barcode').value = '';

    // Reset dropdowns
    document.getElementById('warehouse_select').innerHTML = '<option value="">Select Warehouse...</option>';
    document.getElementById('bin_select').innerHTML = '<option value="">Select Bin Location...</option>';
    document.getElementById('batch_select').innerHTML = '<option value="">Select Batch...</option>';

    // Disable dependent dropdowns
    document.getElementById('bin_select').disabled = true;
    document.getElementById('batch_select').disabled = true;

    // Hide batch/serial sections by default - will be shown after validation
    hideBatchSerialSections();

    // Load initial data
    loadCascadingWarehouses();

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('addItemModal'));
    modal.show();
}

// Submit GRPO for QC approval
function submitGRPO(grpoId) {
    if (confirm('Are you sure you want to submit this GRPO for QC approval?')) {
        fetch(`/grpo/${grpoId}/submit`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('GRPO submitted for QC approval successfully!');
                location.reload();
            } else {
                alert('Error submitting GRPO: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error submitting GRPO');
        });
    }
}

// Generate barcode
function generateBarcode(itemId, itemCode) {
    const randomHex = Math.random().toString(16).substring(2, 10).toUpperCase();
    const generatedBarcode = 'WMS-' + itemCode + '-' + randomHex;

    fetch('/grpo/item/' + itemId + '/update_field', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            field_name: 'generated_barcode',
            value: generatedBarcode
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error generating barcode: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error generating barcode');
    });
}

// Generate QR Label with PO Number
function generateQRLabel(itemCode, itemName, batchNumber, grpoId, poNumber) {
    const data = {
        item_code: itemCode,
        item_name: itemName,
        batch_number: batchNumber,
        grpo_id: grpoId,
        po_number: poNumber
    };

    fetch('/api/generate-qr-label', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Create and show QR code modal
            showQRCodeModal(data.qr_data, data.label_info);
        } else {
            alert('Error generating QR label: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error generating QR label');
    });
}

// Show QR Code Modal
function showQRCodeModal(qrData, labelInfo) {
    // Create modal if it doesn't exist
    let modal = document.getElementById('qrCodeModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.innerHTML = `
            <div class="modal fade" id="qrCodeModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">QR Code</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <div id="qrcode"></div>
                            <div class="mt-3">
                                <p><strong>Item Code:</strong> <span id="qr-item-code"></span></p>
                                <p><strong>PO Number:</strong> <span id="qr-po-number"></span></p>
                                <p><strong>Item Name:</strong> <span id="qr-item-name"></span></p>
                                <p><strong>Batch Number:</strong> <span id="qr-batch-number"></span></p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="printQRLabel()">Print Label</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    // Update modal content
    document.getElementById('qr-item-code').textContent = labelInfo.item_code;
    document.getElementById('qr-po-number').textContent = labelInfo.po_number;
    document.getElementById('qr-item-name').textContent = labelInfo.item_name;
    document.getElementById('qr-batch-number').textContent = labelInfo.batch_number || 'N/A';

    // Generate QR code using QRCode.js library
    const qrCodeDiv = document.getElementById('qrcode');
    qrCodeDiv.innerHTML = '';

    // Load QRCode library if not already loaded
    if (typeof QRCode === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js';
        script.onload = function() {
            generateQRCode(qrCodeDiv, qrData);
        };
        document.head.appendChild(script);
    } else {
        generateQRCode(qrCodeDiv, qrData);
    }

    // Show modal
    const bsModal = new bootstrap.Modal(document.getElementById('qrCodeModal'));
    bsModal.show();
}

// Toggle manual warehouse entry
function toggleManualWarehouse() {
    const warehouseSelect = document.getElementById('warehouse_select');
    const warehouseCode = document.getElementById('warehouse_code');

    if (warehouseCode.style.display === 'none') {
        warehouseCode.style.display = 'block';
        warehouseSelect.parentElement.style.display = 'none';
        warehouseCode.focus();
    } else {
        warehouseCode.style.display = 'none';
        warehouseSelect.parentElement.style.display = 'flex';
        warehouseSelect.focus();
    }
}

// Toggle manual bin entry
function toggleManualBin() {
    const binSelect = document.getElementById('bin_select');
    const binLocation = document.getElementById('bin_location');

    if (binLocation.style.display === 'none') {
        binLocation.style.display = 'block';
        binSelect.parentElement.style.display = 'none';
        binLocation.focus();
    } else {
        binLocation.style.display = 'none';
        binSelect.parentElement.style.display = 'flex';
        binSelect.focus();
    }
}

// Handle bin selection
function handleBinSelection() {
    const binSelect = document.getElementById('bin_select');
    const binLocation = document.getElementById('bin_location');

    if (binSelect.value) {
        binLocation.value = binSelect.value;
        binLocation.style.display = 'none';
        binSelect.parentElement.style.display = 'flex';
    }
}

// Toggle manual bin entry
function toggleManualBin() {
    const binSelect = document.getElementById('bin_select');
    const binLocation = document.getElementById('bin_location');

    if (binLocation.style.display === 'none') {
        binLocation.style.display = 'block';
        binSelect.parentElement.style.display = 'none';
        binLocation.focus();
    } else {
        binLocation.style.display = 'none';
        binSelect.parentElement.style.display = 'flex';
        binSelect.focus();
    }
}

// Handle bin selection
function handleBinSelection() {
    const binSelect = document.getElementById('bin_select');
    const binLocation = document.getElementById('bin_location');

    if (binSelect.value) {
        binLocation.value = binSelect.value;
        binLocation.style.display = 'none';
        binSelect.parentElement.style.display = 'flex';
    }
}

// Load warehouses from SAP B1
function loadWarehouses() {
    console.log('Loading warehouses...');
    fetch('/api/get-warehouses')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const warehouseSelect = document.getElementById('warehouse_select');
                warehouseSelect.innerHTML = '<option value="">Select Warehouse...</option>';

                data.warehouses.forEach(warehouse => {
                    const option = document.createElement('option');
                    option.value = warehouse.WarehouseCode;
                    option.textContent = `${warehouse.WarehouseCode} - ${warehouse.WarehouseName}`;
                    warehouseSelect.appendChild(option);
                });

                console.log(`Loaded ${data.warehouses.length} warehouses`);
            } else {
                console.error('Failed to load warehouses:', data.error);
            }
        })
        .catch(error => {
            console.error('Error loading warehouses:', error);
        });
}

// Load bins for selected warehouse
function loadBins(warehouseCode) {
    console.log(`Loading bins for warehouse: ${warehouseCode}`);
    fetch(`/api/get-bins?warehouse=${warehouseCode}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const binSelect = document.getElementById('bin_select');
                binSelect.innerHTML = '<option value="">Select Bin Location...</option>';

                data.bins.forEach(bin => {
                    const option = document.createElement('option');
                    option.value = bin.BinCode;
                    option.textContent = `${bin.BinCode} - ${bin.BinName || bin.BinCode}`;
                    binSelect.appendChild(option);
                });

                console.log(`Loaded ${data.bins.length} bins for warehouse ${warehouseCode}`);
            } else {
                console.error('Failed to load bins:', data.error);
            }
        })
        .catch(error => {
            console.error('Error loading bins:', error);
        });
}

// Load batches for selected item and warehouse
function loadBatches(warehouseCode) {
    const itemCode = document.getElementById('item_code').value;
    if (!itemCode) {
        console.log('No item code available for batch loading');
        return;
    }

    console.log(`Loading batches for item: ${itemCode}, warehouse: ${warehouseCode}`);
    fetch(`/api/get-batches?item=${itemCode}&warehouse=${warehouseCode}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const batchSelect = document.getElementById('batch_select');
                batchSelect.innerHTML = '<option value="">Select Batch...</option>';

                data.batches.forEach(batch => {
                    const option = document.createElement('option');
                    option.value = batch.Batch;
                    option.textContent = `${batch.Batch} (Qty: ${batch.Quantity || 0}, Exp: ${batch.ExpirationDate || 'N/A'})`;
                    option.setAttribute('data-expiry', batch.ExpirationDate || '');
                    option.setAttribute('data-quantity', batch.Quantity || 0);
                    batchSelect.appendChild(option);
                });

                console.log(`Loaded ${data.batches.length} batches for item ${itemCode}`);
            } else {
                console.error('Failed to load batches:', data.error);
            }
        })
        .catch(error => {
            console.error('Error loading batches:', error);
        });
}


// Generate QR Code
function generateQRCode(container, data) {
    try {
        QRCode.toCanvas(data, { width: 200, height: 200 }, function (error, canvas) {
            if (error) {
                console.error('QR Code generation error:', error);
                container.innerHTML = '<p class="text-danger">Error generating QR code</p>';
            } else {
                container.innerHTML = '';
                container.appendChild(canvas);
            }
        });
    } catch (error) {
        console.error('QR Code library error:', error);
        container.innerHTML = '<p class="text-info">QR Code: ' + data + '</p>';
    }
}

// Print QR Label
function printQRLabel() {
    window.print();
}

// GRPO submission functions
function submitGRPO(grpoId) {
    const submitBtn = document.getElementById('submitQCBtn');
    if (submitBtn && submitBtn.disabled) {
        return;
    }

    if (confirm('Submit this GRPO for QC approval?')) {
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i data-feather="loader"></i> Submitting...';
        }

        fetch('/grpo/' + grpoId + '/submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i data-feather="check"></i> Submit for QC Approval';
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error submitting GRPO');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i data-feather="check"></i> Submit for QC Approval';
            }
        });
    }
}

function approveGRPO(grpoId) {
    const approveBtn = event.target;
    if (approveBtn.disabled) {
        return;
    }

    if (confirm('Approve this GRPO and post to SAP B1?')) {
        approveBtn.disabled = true;
        approveBtn.innerHTML = '<i data-feather="loader"></i> Posting to SAP B1...';

        fetch('/grpo/' + grpoId + '/approve', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                draft_or_post: 'post',
                qc_notes: ''
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('Success: ' + data.message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
                approveBtn.disabled = false;
                approveBtn.innerHTML = '<i data-feather="check"></i> Approve & Post to SAP';
            }
        })
        .catch(error => {
            console.error('Error approving GRPO:', error);
            alert('Error approving GRPO: ' + error.message);
            approveBtn.disabled = false;
            approveBtn.innerHTML = '<i data-feather="check"></i> Approve & Post to SAP';
        });
    }
}

function rejectGRPO(grpoId) {
    if (confirm('Reject this GRPO?')) {
        fetch('/grpo/' + grpoId + '/reject', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                qc_notes: ''
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('GRPO rejected successfully');
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error rejecting GRPO:', error);
            alert('Error rejecting GRPO: ' + error.message);
        });
    }
}

function showJsonPreview(grpoId) {
    fetch('/api/grpo/' + grpoId + '/preview_json')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const formattedJson = JSON.stringify(data.json_data, null, 2);
                alert('JSON Preview:\n\n' + formattedJson);
            } else {
                alert('Error getting JSON preview: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error getting JSON preview');
        });
}

// Prevent multiple POST submissions
function postToSAPConfirm(button) {
    if (button.disabled) {
        return false;
    }

    if (confirm('Post this GRPO to SAP B1 as Purchase Delivery Note?')) {
        button.disabled = true;
        button.innerHTML = '<i data-feather="loader"></i> Posting...';
        return true;
    }
    return false;
}

// QR Code Generation Functions - prevent duplicate declarations
if (typeof window.currentQRData === 'undefined') {
    window.currentQRData = {};
}

function generateQRLabel(itemCode, itemName, batchNumber, grpoId, poNumber) {
    window.currentQRData = {
        item_code: itemCode,
        item_name: itemName,
        batch_number: batchNumber || null,
        po_number: poNumber,
        format: 'TEXT'
    };

    generateQRCodeAPI();

    const modal = new bootstrap.Modal(document.getElementById('qrCodeModal'));
    modal.show();
}

function generateQRCodeAPI() {
    document.getElementById('qrCodeContainer').innerHTML = '<div class="alert alert-info">QR Code content is ready for scanning (visual QR code requires QR library)</div>';

    fetch('/api/generate-label-qr', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(window.currentQRData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayQRCode(data.qr_content, data.qr_image_data);
        } else {
            console.error('QR code generation failed:', data.error);
            document.getElementById('qrCodeContainer').innerHTML = '<p class="text-danger">Error generating QR code: ' + (data.error || 'Unknown error') + '</p>';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('qrCodeContainer').innerHTML = '<p class="text-danger">Error generating QR code</p>';
    });
}

function displayQRCode(content, imageData) {
    const container = document.getElementById('qrCodeContainer');
    const textContainer = document.getElementById('qrCodeText');

    // Display QR code content as text
    if (textContainer) {
        textContainer.innerHTML = '<pre>' + content + '</pre>';
    }

    // If we have image data from server, display it directly
    if (imageData) {
        container.innerHTML = '<img src="data:image/png;base64,' + imageData + '" alt="QR Code" style="max-width: 300px; max-height: 300px;" class="img-fluid">';
    } else if (typeof QRCode !== 'undefined') {
        // Fallback to client-side generation
        QRCode.toCanvas(container, content, { width: 200, height: 200 }, function (error, canvas) {
            if (error) {
                console.error('QR Code generation error:', error);
                container.innerHTML = '<div class="alert alert-success">âœ… QR Code generated successfully</div>';
            } else {
                container.innerHTML = '';
                container.appendChild(canvas);
            }
        });
    } else {
        container.innerHTML = '<div class="alert alert-success">âœ… QR Code generated successfully</div>';
    }
}

function regenerateQR() {
    const format = document.getElementById('qrFormat').value;
    window.currentQRData.format = format;
    generateQRCodeAPI();
}

// Print function for clean QR label
function printQRLabel() {
    const qrContainer = document.getElementById('qrCodeContainer');
    const qrContent = qrContainer.innerHTML;

    // Create a clean print window with only QR code
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title></title>
            <style>
                body {
                    margin: 0;
                    padding: 20px;
                    text-align: center;
                    font-family: Arial, sans-serif;
                }
                .qr-container {
                    display: inline-block;
                    border: 2px solid #000;
                    padding: 20px;
                    margin: 20px auto;
                }
                img {
                    display: block;
                    margin: 0 auto;
                    max-width: 300px;
                    max-height: 300px;
                }
                .qr-title {
                    font-size: 18px;
                    font-weight: bold;
                    margin-bottom: 10px;
                }
                @media print {
                    body { margin: 0; padding: 0; }
                    .qr-container { border: 2px solid #000; }
                }
            </style>
        </head>
        <body>
            <div class="qr-container">
                <div class="qr-title"></div>
                ${qrContent}
            </div>
        </body>
        </html>
    `);

    printWindow.document.close();
    printWindow.focus();

    // Auto-print after a short delay
    setTimeout(() => {
        printWindow.print();
        printWindow.close();
    }, 500);
}

// Wait for QRCode library to load
function waitForQRCode(callback, timeout = 5000) {
    console.log('Waiting for QRCode library...');
    console.log('QRCode available:', typeof QRCode !== 'undefined');
    
    const startTime = Date.now();
    const checkInterval = setInterval(() => {
        if (typeof QRCode !== 'undefined') {
            console.log('âœ… QRCode library loaded successfully!');
            clearInterval(checkInterval);
            callback(true);
        } else if (Date.now() - startTime > timeout) {
            console.error('âŒ QRCode library failed to load after 5 seconds');
            console.error('Please do a hard refresh: Ctrl+Shift+R (Windows) or Cmd+Shift+R (Mac)');
            clearInterval(checkInterval);
            callback(false);
        }
    }, 100);
}

// Generate QR labels for all serial numbers with comprehensive details
function generateSerialQRLabels(itemId, itemCode, itemName) {
    fetch(`/grpo/items/${itemId}/serial-numbers`, {
        credentials: 'same-origin'
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data.success || !data.serial_numbers || data.serial_numbers.length === 0) {
                alert('No serial numbers found for this item');
                return;
            }

            const serialNumbers = data.serial_numbers;
            const grpoDetails = data.grpo_details || {};
            const modal = new bootstrap.Modal(document.getElementById('serialQRLabelsModal'));
            const container = document.getElementById('serialQRLabelsContainer');
            container.innerHTML = '';

            // Wait for QRCode library then generate codes
            waitForQRCode((loaded) => {
                let totalLabelsGenerated = 0;
                
                serialNumbers.forEach((serial, serialIndex) => {
                    const qtyPerPack = serial.qty_per_pack || 1;
                    const numberOfPacks = serial.no_of_packs || 1;
                    
                    // Generate one QR code per pack based on no_of_packs
                    for (let packNum = 1; packNum <= numberOfPacks; packNum++) {
                        totalLabelsGenerated++;
                        
                        // Generate comprehensive QR data with all requested fields in JSON format
                        const qrDataObj = {
                            'id': grpoDetails.doc_number || 'N/A',
                            'po': grpoDetails.po_number || 'N/A',
                            'item': itemCode,
                            'SerialNumber': serial.internal_serial_number,
                            'qty': qtyPerPack,
                            'pack': `${packNum} of ${numberOfPacks}`,
                            'grn_date': grpoDetails.grn_date || 'N/A',
                            'exp_date': serial.expiry_date || 'N/A'
                        };
                        
                        // Convert to JSON format for QR code
                        const qrData = JSON.stringify(qrDataObj);

                        const qrDiv = document.createElement('div');
                        qrDiv.className = 'qr-label-item col-md-4 mb-3';

                        qrDiv.innerHTML = `
                            <div class="text-center p-3 border rounded">
                                <h6 class="mb-2"><strong>${itemCode}</strong></h6>
                                <p class="mb-1 small">${itemName}</p>
                                <div class="qr-code-container mb-2"></div>
                                <p class="mb-1 small"><strong>${grpoDetails.doc_number || 'N/A'}</strong></p>
                                <div class="small text-start">
                                    <strong>PO:</strong> ${grpoDetails.po_number || 'N/A'}<br>
                                    <strong>Serial:</strong> ${serial.internal_serial_number}<br>
                                    ${serial.manufacturer_serial_number ? `<strong>MFG:</strong> ${serial.manufacturer_serial_number}<br>` : ''}
                                    <strong>Qty per Pack:</strong> ${qtyPerPack}<br>
                                    <strong>Pack:</strong> ${packNum} of ${numberOfPacks}<br>
                                    <strong>GRN Date:</strong> ${grpoDetails.grn_date || 'N/A'}<br>
                                    <strong>Exp Date:</strong> ${serial.expiry_date || 'N/A'}
                                </div>
                            </div>
                        `;
                        container.appendChild(qrDiv);

                        // Get QR container for code generation
                        const qrContainer = qrDiv.querySelector('.qr-code-container');

                        // Generate QR code using qrcodejs
                        if (loaded && typeof QRCode !== 'undefined') {
                            try {
                                new QRCode(qrContainer, {
                                    text: qrData,
                                    width: 150,
                                    height: 150,
                                    colorDark: '#000000',
                                    colorLight: '#ffffff',
                                    correctLevel: QRCode.CorrectLevel.H
                                });
                            } catch (error) {
                                console.error('QR generation error:', error);
                                qrContainer.innerHTML = `<p class="text-danger">Error generating QR: ${error.message}</p>`;
                            }
                        } else {
                            qrContainer.innerHTML = `<p class="text-danger">QR library not loaded. Please do a hard refresh (Ctrl+Shift+R)</p>`;
                        }
                    }
                });

                console.log(`Generated ${totalLabelsGenerated} serial QR code labels`);
                modal.show();
            });
        })
        .catch(error => {
            console.error('Error fetching serial numbers:', error);
            alert(`Error loading serial numbers: ${error.message}\n\nPlease check:\n1. Item has serial numbers saved\n2. You are logged in\n3. Check browser console for details`);
        });
}

// Generate QR labels for all batch numbers with multiple labels per batch based on quantity
function generateBatchQRLabels(itemId, itemCode, itemName) {
    fetch(`/grpo/items/${itemId}/batch-numbers`, {
        credentials: 'same-origin'
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data.success || !data.batch_numbers || data.batch_numbers.length === 0) {
                alert('No batch numbers found for this item');
                return;
            }

            const batchNumbers = data.batch_numbers;
            const grpoDetails = data.grpo_details;
            const modal = new bootstrap.Modal(document.getElementById('serialQRLabelsModal'));
            const container = document.getElementById('serialQRLabelsContainer');
            container.innerHTML = '';

            let totalLabelsGenerated = 0;

            // Wait for QRCode library then generate codes
            waitForQRCode((loaded) => {
                batchNumbers.forEach((batch, batchIndex) => {
                    const receivedQty = Math.floor(batch.quantity);
                    const numberOfPacks = batch.no_of_packs || 1;
                    const qtyPerPack = batch.qty_per_pack || receivedQty;

                    // Generate one QR code per pack based on no_of_packs
                    for (let packNum = 1; packNum <= numberOfPacks; packNum++) {
                        totalLabelsGenerated++;

                        // Use proper doc_number from GRPO document
                        const docNumber = grpoDetails.doc_number || 'N/A';

                        // Comprehensive QR data with all required fields in JSON format
                        const qrDataObj = {
                            'id': docNumber,
                            'po': grpoDetails.po_number,
                            'item': itemCode,
                            'batch': batch.batch_number,
                            'qty': qtyPerPack,
                            'pack': `${packNum} of ${numberOfPacks}`,
                            'grn_date': grpoDetails.grn_date,
                            'exp_date': batch.expiry_date || 'N/A'
                        };
                        
                        // Convert to JSON format for QR code
                        const qrData = JSON.stringify(qrDataObj);

                        const qrDiv = document.createElement('div');
                        qrDiv.className = 'qr-label-item col-md-4 mb-3';

                        qrDiv.innerHTML = `
                            <div class="text-center p-3 border rounded">
                                <h6 class="mb-2"><strong>${itemCode}</strong></h6>
                                <p class="mb-1 small">${itemName}</p>
                                <div class="qr-code-container mb-2"></div>
                                <p class="mb-1 small"><strong>${docNumber}</strong></p>
                                <div class="small text-start">
                                    <strong>PO:</strong> ${grpoDetails.po_number}<br>
                                    <strong>Batch:</strong> ${batch.batch_number}<br>
                                    <strong>Qty per Pack:</strong> ${qtyPerPack}<br>
                                    <strong>Pack:</strong> ${packNum} of ${numberOfPacks}<br>
                                    <strong>GRN Date:</strong> ${grpoDetails.grn_date}<br>
                                    <strong>Exp Date:</strong> ${batch.expiry_date || 'N/A'}
                                </div>
                            </div>
                        `;
                        container.appendChild(qrDiv);

                        // Get QR container for code generation
                        const qrContainer = qrDiv.querySelector('.qr-code-container');

                        // Generate QR code using qrcodejs
                        if (loaded && typeof QRCode !== 'undefined') {
                            try {
                                new QRCode(qrContainer, {
                                    text: qrData,
                                    width: 150,
                                    height: 150,
                                    colorDark: '#000000',
                                    colorLight: '#ffffff',
                                    correctLevel: QRCode.CorrectLevel.H
                                });
                            } catch (error) {
                                console.error('QR generation error:', error);
                                qrContainer.innerHTML = `<p class="text-danger">Error generating QR</p>`;
                            }
                        } else {
                            qrContainer.innerHTML = `<p class="text-danger">QR library not loaded</p>`;
                        }
                    }
                });

                console.log(`Generated ${totalLabelsGenerated} QR code labels`);
                modal.show();
            });
        })
        .catch(error => {
            console.error('Error fetching batch numbers:', error);
            alert(`Error loading batch numbers: ${error.message}\n\nPlease check:\n1. Item has batch numbers saved\n2. You are logged in\n3. Check browser console for details`);
        });
}

// Generate QR labels for non-managed items
function generateNonManagedQRLabels(itemId, itemCode, itemName) {
    fetch(`/grpo/items/${itemId}/non-managed-items`, {
        credentials: 'same-origin'
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data.success || !data.non_managed_items || data.non_managed_items.length === 0) {
                alert('No non-managed item records found for this item');
                return;
            }

            const nonManagedItems = data.non_managed_items;
            const grpoDetails = data.grpo_details;
            const modal = new bootstrap.Modal(document.getElementById('serialQRLabelsModal'));
            const container = document.getElementById('serialQRLabelsContainer');
            container.innerHTML = '';

            let totalLabelsGenerated = 0;

            // Wait for QRCode library then generate codes
            waitForQRCode((loaded) => {
                nonManagedItems.forEach((nmItem, index) => {
                    totalLabelsGenerated++;

                    // Use proper GRN number from non-managed item record
                    const grnNumber = nmItem.grn_number || grpoDetails.doc_number || 'N/A';
                    const packNumber = nmItem.pack_number || index + 1;
                    const totalPacks = nmItem.no_of_packs || data.count;
                    const qtyPerPack = nmItem.qty_per_pack || nmItem.quantity;

                    // Comprehensive QR data with all required fields in JSON format
                    const qrDataObj = {
                        'id': grnNumber,
                        'po': grpoDetails.po_number,
                        'item': itemCode,
                        'desc': itemName,
                        'qty': qtyPerPack,
                        'pack': `${packNumber} of ${totalPacks}`,
                        'grn_date': nmItem.admin_date || grpoDetails.grn_date,
                        'exp_date': nmItem.expiry_date || 'N/A'
                    };
                    
                    // Convert to JSON format for QR code
                    const qrData = JSON.stringify(qrDataObj);

                    const qrDiv = document.createElement('div');
                    qrDiv.className = 'qr-label-item col-md-4 mb-3';

                    qrDiv.innerHTML = `
                        <div class="text-center p-3 border rounded">
                            <h6 class="mb-2"><strong>${itemCode}</strong></h6>
                            <p class="mb-1 small">${itemName}</p>
                            <div class="qr-code-container mb-2"></div>
                            <p class="mb-1 small"><strong>${grnNumber}</strong></p>
                            <div class="small text-start">
                                <strong>PO:</strong> ${grpoDetails.po_number}<br>
                                <strong>Qty per Pack:</strong> ${qtyPerPack}<br>
                                <strong>Pack:</strong> ${packNumber} of ${totalPacks}<br>
                                <strong>GRN Date:</strong> ${nmItem.admin_date || grpoDetails.grn_date}<br>
                                <strong>Exp Date:</strong> ${nmItem.expiry_date || 'N/A'}
                            </div>
                        </div>
                    `;
                    container.appendChild(qrDiv);

                    // Get QR container for code generation
                    const qrContainer = qrDiv.querySelector('.qr-code-container');

                    // Generate QR code using qrcodejs
                    if (loaded && typeof QRCode !== 'undefined') {
                        try {
                            new QRCode(qrContainer, {
                                text: qrData,
                                width: 150,
                                height: 150,
                                colorDark: '#000000',
                                colorLight: '#ffffff',
                                correctLevel: QRCode.CorrectLevel.H
                            });
                        } catch (error) {
                            console.error('QR generation error:', error);
                            qrContainer.innerHTML = `<p class="text-danger">Error generating QR</p>`;
                        }
                    } else {
                        qrContainer.innerHTML = `<p class="text-danger">QR library not loaded</p>`;
                    }
                });

                console.log(`Generated ${totalLabelsGenerated} QR code labels for non-managed items`);
                modal.show();
            });
        })
        .catch(error => {
            console.error('Error fetching non-managed items:', error);
            alert(`Error loading non-managed items: ${error.message}\n\nPlease check:\n1. Item has non-managed item records saved\n2. You are logged in\n3. Check browser console for details`);
        });
}

// Print all serial/batch QR labels
function printAllQRLabels() {
    const container = document.getElementById('serialQRLabelsContainer');
    const printWindow = window.open('', '_blank', 'width=800,height=600');

    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Print QR Labels</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    margin: 0;
                    padding: 20px;
                }
                .qr-label-item {
                    page-break-inside: avoid;
                    margin-bottom: 20px;
                }
                .text-center {
                    text-align: center;
                }
                .p-3 {
                    padding: 15px;
                }
                .border {
                    border: 2px solid #000;
                }
                .rounded {
                    border-radius: 8px;
                }
                .mb-3 {
                    margin-bottom: 15px;
                }
                h6 {
                    font-size: 16px;
                    font-weight: bold;
                    margin: 0 0 10px 0;
                }
                p {
                    margin: 5px 0;
                }
                canvas {
                    max-width: 100%;
                }
                @media print {
                    body {
                        margin: 0;
                        padding: 10px;
                    }
                    .qr-label-item {
                        page-break-after: always;
                    }
                    .qr-label-item:last-child {
                        page-break-after: auto;
                    }
                }
            </style>
        </head>
        <body>
            ${container.innerHTML}
        </body>
        </html>
    `);

    printWindow.document.close();
    printWindow.focus();

    setTimeout(() => {
        printWindow.print();
    }, 500);
}

// Set up event listeners when page loads
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.add-item-btn').forEach(button => {
        button.addEventListener('click', function() {
            const itemCode = this.getAttribute('data-item-code');
            const itemName = this.getAttribute('data-item-name');
            const uom = this.getAttribute('data-uom');
            const warehouse = this.getAttribute('data-warehouse');
            const poItemJson = this.getAttribute('data-po-item');

            let poItemData = null;
            try {
                poItemData = JSON.parse(poItemJson);
            } catch (e) {
                console.warn('Could not parse PO item data:', e);
            }

            addItemToGRPO(itemCode, itemName, uom, warehouse, poItemData);
        });
    });
});
</script>
{% endblock %}

<!-- Serial/Batch QR Labels Modal -->
<div class="modal fade" id="serialQRLabelsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i data-feather="hash"></i> QR Code Labels
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="max-height: 600px; overflow-y: auto;">
                <div id="serialQRLabelsContainer" class="row">
                    <!-- QR labels will be generated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="printAllQRLabels()">
                    <i data-feather="printer"></i> Print All Labels
                </button>
            </div>
        </div>
    </div>
</div>

<!-- QR Code Label Modal -->
<div class="modal fade" id="qrCodeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">QR Code Label</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <div id="qrCodeContainer" class="mb-3"></div>

                    <div class="card">
                        <div class="card-body">
                            <div id="qrCodeText" class="text-start">
                                <!-- QR code content will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <label class="form-label">QR Format:</label>
                        <select id="qrFormat" class="form-select" onchange="regenerateQR()">
                            <option value="TEXT">Text Format</option>
                            <option value="JSON">JSON Format</option>
                            <option value="CSV">CSV Format</option>
                        </select>
                    </div>
                    <div class="col-md-6 d-flex align-items-end">
                        <button class="btn btn-secondary w-100" onclick="regenerateQR()">
                            <i data-feather="refresh-cw"></i> Regenerate
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="printQRLabel()">
                    <i data-feather="printer"></i> Print Label
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}